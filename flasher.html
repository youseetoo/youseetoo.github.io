<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>UC2 ESP32 Firmware Flashing Tool</title>
    <meta
      name="description"
      content="Flash and configure UC2 ESP32 firmware directly in your browser."
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark light" />

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- ESP Web Tools -->
    <script
      type="module"
      src="https://unpkg.com/esp-web-tools@10.0.1/dist/web/install-button.js?module"
    ></script>

    <!-- ESPTool.js for erase functionality -->
    <script src="https://unpkg.com/esptool-js@0.4.3/bundle.js"></script>
    <script>
      // Expose esptool classes globally after load
      window.addEventListener('load', () => {
        if (typeof esptoolPackage !== 'undefined') {
          window.Transport = esptoolPackage.Transport;
          window.ESPLoader = esptoolPackage.ESPLoader;
          console.log('✓ ESPTool.js loaded:', { Transport: !!window.Transport, ESPLoader: !!window.ESPLoader });
        } else {
          console.error('✗ esptoolPackage not found');
        }
      });
    </script>
    <script>
      // Wait for esptool to load and expose globals
      window.addEventListener('DOMContentLoaded', () => {
        if (typeof esptoolPackage !== 'undefined') {
          window.Transport = esptoolPackage.Transport;
          window.ESPLoader = esptoolPackage.ESPLoader;
          console.log('ESPTool.js loaded successfully');
        }
      });
    </script>

    <style>
      :root {
        --uc2-primary: #0d6efd;
        --uc2-success: #198754;
        --uc2-warning: #ffc107;
        --uc2-danger: #dc3545;
      }

      /* Board selection styling */
      .board-card {
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
      }
      .board-card:hover {
        border-color: var(--uc2-primary);
        transform: translateY(-2px);
      }
      .board-card.selected {
        border-color: var(--uc2-primary);
        background-color: rgba(13, 110, 253, 0.1);
      }
      .board-img {
        width: 100px;
        height: 100px;
        object-fit: contain;
      }

      /* Console output styling */
      .console-output {
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 12px;
        padding: 1rem;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-all;
      }
      .console-output .success { color: #4ec9b0; }
      .console-output .error { color: #f14c4c; }
      .console-output .warning { color: #cca700; }
      .console-output .info { color: #3794ff; }

      /* Progress indicator */
      .progress-step {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
      }
      .progress-step.active {
        background-color: rgba(13, 110, 253, 0.1);
      }
      .progress-step.completed {
        background-color: rgba(25, 135, 84, 0.1);
      }
      .progress-step .step-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        font-size: 12px;
      }
      .progress-step.pending .step-icon {
        background-color: #6c757d;
        color: white;
      }
      .progress-step.active .step-icon {
        background-color: var(--uc2-primary);
        color: white;
      }
      .progress-step.completed .step-icon {
        background-color: var(--uc2-success);
        color: white;
      }

      /* CAN ID configuration */
      .can-preset {
        cursor: pointer;
        padding: 0.5rem 1rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin: 0.25rem;
        transition: all 0.2s;
      }
      .can-preset:hover {
        border-color: var(--uc2-primary);
      }
      .can-preset.selected {
        border-color: var(--uc2-primary);
        background-color: rgba(13, 110, 253, 0.1);
      }

      /* Version badge */
      .version-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }

      /* Tab content padding */
      .tab-pane {
        padding: 1.5rem 0;
      }

      /* Loading spinner */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      /* Hide by default */
      .hidden { display: none !important; }
    </style>
  </head>
  <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#">
          <img
            src="https://raw.githubusercontent.com/openUC2/openUC2.github.io/master/static/img/Artboard4%404x.png"
            width="40"
            alt="UC2 Logo"
            class="me-2"
          />
          openUC2 Flasher
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="https://openuc2.discourse.group" target="_blank">
                <i class="bi bi-chat-dots"></i> Forum
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://github.com/youseetoo/uc2-esp32" target="_blank">
                <i class="bi bi-github"></i> GitHub
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://openuc2.github.io" target="_blank">
                <i class="bi bi-book"></i> Docs
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- HEADER -->
    <header class="bg-light py-4">
      <div class="container text-center">
        <h1 class="display-6">
          <i class="bi bi-cpu"></i> UC2 ESP32 Firmware Tool
        </h1>
        <p class="lead text-muted">
          Flash, configure, and manage your UC2 ESP32 boards directly in the browser
        </p>
        <div id="browserWarning" class="alert alert-warning hidden">
          <i class="bi bi-exclamation-triangle"></i>
          <strong>Browser not supported!</strong> Please use Chrome, Edge, or Opera for WebSerial support.
        </div>
      </div>
    </header>

    <div class="container my-4">
      <!-- MAIN TABS -->
      <ul class="nav nav-tabs nav-fill" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="flash-tab"
            data-bs-toggle="tab"
            data-bs-target="#flash-pane"
            type="button"
          >
            <i class="bi bi-lightning-charge"></i> Flash Firmware
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="configure-tab"
            data-bs-toggle="tab"
            data-bs-target="#configure-pane"
            type="button"
          >
            <i class="bi bi-gear"></i> Configure Device
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="erase-tab"
            data-bs-toggle="tab"
            data-bs-target="#erase-pane"
            type="button"
          >
            <i class="bi bi-trash"></i> Erase Flash
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="help-tab"
            data-bs-toggle="tab"
            data-bs-target="#help-pane"
            type="button"
          >
            <i class="bi bi-question-circle"></i> Help
          </button>
        </li>
      </ul>

      <div class="tab-content" id="mainTabContent">
        <!-- FLASH TAB -->
        <div class="tab-pane fade show active" id="flash-pane" role="tabpanel">
          <div class="row">
            <!-- Left column: Board & Version Selection -->
            <div class="col-lg-8">
              <!-- Version Selection -->
              <div class="card mb-4">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-tag"></i> Select Version</h5>
                </div>
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-md-6">
                      <label for="releaseSelect" class="form-label">Firmware Release</label>
                      <select id="releaseSelect" class="form-select">
                        <option value="latest">Latest Stable</option>
                        <!-- Dynamically populated -->
                      </select>
                    </div>
                    <div class="col-md-6">
                      <div id="releaseInfo" class="mt-3 mt-md-0">
                        <span class="badge bg-secondary version-badge" id="currentVersion">Loading...</span>
                        <small class="text-muted d-block mt-1" id="releaseDate"></small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Board Selection -->
              <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="mb-0"><i class="bi bi-motherboard"></i> Select Board</h5>
                  <input
                    type="text"
                    id="boardSearch"
                    class="form-control form-control-sm w-auto"
                    placeholder="Search boards..."
                    style="max-width: 200px;"
                  />
                </div>
                <div class="card-body">
                  <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3" id="boardGrid">
                    <!-- Boards are dynamically populated -->
                    <div class="col text-center">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <p class="mt-2">Loading boards...</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Board Info -->
              <div class="card mb-4 hidden" id="boardInfoCard">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-info-circle"></i> Board Information</h5>
                </div>
                <div class="card-body" id="boardInfo">
                  <!-- Board details shown here -->
                </div>
              </div>
            </div>

            <!-- Right column: Flash Controls -->
            <div class="col-lg-4">
              <div class="card sticky-top" style="top: 1rem;">
                <div class="card-header bg-primary text-white">
                  <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Flash Controls</h5>
                </div>
                <div class="card-body">
                  <!-- Selected Board Summary -->
                  <div class="mb-3">
                    <small class="text-muted">Selected Board:</small>
                    <div id="selectedBoardName" class="fw-bold">None selected</div>
                    <small class="text-muted" id="selectedBoardChip"></small>
                  </div>

                  <!-- ESP Web Install Button -->
                  <div class="text-center mb-3">
                    <esp-web-install-button id="installButton">
                      <button slot="activate" class="btn btn-primary btn-lg w-100" disabled>
                        <i class="bi bi-lightning-charge"></i> Install Firmware
                      </button>
                      <span slot="unsupported">
                        <div class="alert alert-danger">
                          Your browser doesn't support Web Serial.<br/>
                          Use Chrome, Edge, or Opera.
                        </div>
                      </span>
                      <span slot="not-allowed">
                        <div class="alert alert-warning">
                          Connection not allowed. Try again.
                        </div>
                      </span>
                    </esp-web-install-button>
                  </div>

                  <!-- Post-Flash Options -->
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="postFlashConfig" checked>
                    <label class="form-check-label" for="postFlashConfig">
                      Configure after flash
                    </label>
                    <small class="text-muted d-block">Send CAN ID or other settings after flashing</small>
                  </div>

                  <!-- Direct Link -->
                  <div class="mt-4 pt-3 border-top">
                    <small class="text-muted">Share direct link:</small>
                    <div class="input-group input-group-sm mt-1">
                      <input type="text" class="form-control" id="directLink" readonly>
                      <button class="btn btn-outline-secondary" type="button" id="copyLinkBtn">
                        <i class="bi bi-clipboard"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CONFIGURE TAB -->
        <div class="tab-pane fade" id="configure-pane" role="tabpanel">
          <div class="row">
            <div class="col-lg-8">
              <!-- Serial Connection -->
              <div class="card mb-4">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-usb-symbol"></i> Serial Connection</h5>
                </div>
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-md-6">
                      <button id="connectSerialBtn" class="btn btn-primary">
                        <i class="bi bi-plug"></i> Connect
                      </button>
                      <span id="connectionStatus" class="ms-2 badge bg-secondary">Disconnected</span>
                    </div>
                    <div class="col-md-6">
                      <select id="baudRate" class="form-select">
                        <option value="115200" selected>115200 baud</option>
                        <option value="9600">9600 baud</option>
                        <option value="57600">57600 baud</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- CAN ID Configuration -->
              <div class="card mb-4">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-diagram-3"></i> CAN ID Configuration</h5>
                </div>
                <div class="card-body">
                  <p class="text-muted">Select the role for this device in your CAN network:</p>
                  
                  <div class="d-flex flex-wrap" id="canPresets">
                    <div class="can-preset" data-address="1" data-role="MASTER">
                      <strong>Master</strong><br>
                      <small class="text-muted">Address: 1</small>
                    </div>
                    <div class="can-preset" data-address="11" data-role="X-Axis">
                      <strong>X-Axis</strong><br>
                      <small class="text-muted">Address: 11</small>
                    </div>
                    <div class="can-preset" data-address="12" data-role="Y-Axis">
                      <strong>Y-Axis</strong><br>
                      <small class="text-muted">Address: 12</small>
                    </div>
                    <div class="can-preset" data-address="13" data-role="Z-Axis">
                      <strong>Z-Axis</strong><br>
                      <small class="text-muted">Address: 13</small>
                    </div>
                    <div class="can-preset" data-address="10" data-role="A-Axis">
                      <strong>A-Axis</strong><br>
                      <small class="text-muted">Address: 10</small>
                    </div>
                    <div class="can-preset" data-address="30" data-role="LED">
                      <strong>LED</strong><br>
                      <small class="text-muted">Address: 30</small>
                    </div>
                  </div>

                  <div class="mt-3">
                    <label for="customCanId" class="form-label">Or enter custom CAN ID:</label>
                    <div class="input-group">
                      <input type="number" class="form-control" id="customCanId" min="0" max="255" placeholder="0-255">
                      <button class="btn btn-outline-primary" id="setCustomCanBtn">Set</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Custom Commands -->
              <div class="card mb-4">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-terminal"></i> Send Custom Command</h5>
                </div>
                <div class="card-body">
                  <div class="input-group mb-3">
                    <input type="text" class="form-control" id="customCommand" placeholder='{"task":"/state", "get": true}'>
                    <button class="btn btn-primary" id="sendCommandBtn">
                      <i class="bi bi-send"></i> Send
                    </button>
                  </div>
                  <div class="mb-2">
                    <small class="text-muted">Quick commands:</small>
                  </div>
                  <div class="d-flex flex-wrap gap-1">
                    <button class="btn btn-sm btn-outline-secondary quick-cmd" data-cmd='{"task":"/state", "get": true}'>Get State</button>
                    <button class="btn btn-sm btn-outline-secondary quick-cmd" data-cmd='{"task":"/motor_act", "motor": {"steppers": [{"stepperid": 0, "position": 1000, "speed": 10000}]}}'>Move Motor</button>
                    <button class="btn btn-sm btn-outline-secondary quick-cmd" data-cmd='{"task":"/ledarr_act", "led": {"LEDArrMode": 1, "led_array": [{"id": 0, "r": 255, "g": 255, "b": 255}]}}'>LED On</button>
                    <button class="btn btn-sm btn-outline-secondary quick-cmd" data-cmd='{"task":"/ledarr_act", "led": {"LEDArrMode": 0}}'>LED Off</button>
                    <button class="btn btn-sm btn-outline-secondary quick-cmd" data-cmd='{"task":"/laser_act", "LASERid": 0, "LASERval": 512}'>Laser On</button>
                    <button class="btn btn-sm btn-outline-secondary quick-cmd" data-cmd='{"task":"/laser_act", "LASERid": 0, "LASERval": 0}'>Laser Off</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Console Output -->
            <div class="col-lg-4">
              <div class="card sticky-top" style="top: 1rem;">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="mb-0"><i class="bi bi-terminal"></i> Console</h5>
                  <button class="btn btn-sm btn-outline-secondary" id="clearConsoleBtn">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
                <div class="card-body p-0">
                  <div class="console-output" id="consoleOutput">
                    <span class="info">Ready. Connect to a device to begin.</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ERASE TAB -->
        <div class="tab-pane fade" id="erase-pane" role="tabpanel">
          <div class="row justify-content-center">
            <div class="col-lg-8">
              <div class="card">
                <div class="card-header bg-danger text-white">
                  <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Erase Flash Memory</h5>
                </div>
                <div class="card-body">
                  <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Warning!</strong> This will completely erase the flash memory of your ESP32.
                    All firmware and settings will be lost. You will need to re-flash the firmware afterwards.
                  </div>

                  <div class="row">
                    <div class="col-md-6">
                      <h6>When to use:</h6>
                      <ul>
                        <li>Firmware is corrupted and won't boot</li>
                        <li>Previous flash failed midway</li>
                        <li>Want a clean slate before flashing</li>
                        <li>Troubleshooting boot issues</li>
                      </ul>
                    </div>
                    <div class="col-md-6">
                      <h6>Erase Options:</h6>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="eraseType" id="eraseAll" value="all" checked>
                        <label class="form-check-label" for="eraseAll">
                          <strong>Full Erase</strong> - Erase entire flash
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="eraseType" id="eraseNvs" value="nvs">
                        <label class="form-check-label" for="eraseNvs">
                          <strong>NVS Only</strong> - Erase settings only
                        </label>
                      </div>
                    </div>
                  </div>

                  <hr>

                  <div class="text-center">
                    <button id="eraseFlashBtn" class="btn btn-danger btn-lg">
                      <i class="bi bi-trash"></i> Erase Flash
                    </button>
                  </div>

                  <!-- Erase Progress -->
                  <div id="eraseProgress" class="mt-4 hidden">
                    <div class="progress mb-2">
                      <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" 
                           role="progressbar" style="width: 0%" id="eraseProgressBar"></div>
                    </div>
                    <p class="text-center mb-0" id="eraseStatus">Connecting...</p>
                  </div>

                  <!-- Erase Console -->
                  <div class="console-output mt-3" id="eraseConsole" style="max-height: 200px;">
                    <span class="info">Click "Erase Flash" to begin...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- HELP TAB -->
        <div class="tab-pane fade" id="help-pane" role="tabpanel">
          <div class="row">
            <div class="col-lg-8">
              <!-- Drivers -->
              <div class="card mb-4">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-download"></i> 1. Install Drivers</h5>
                </div>
                <div class="card-body">
                  <p>Most ESP32 boards use USB-to-UART chips. Install the correct driver if your board isn't recognized:</p>
                  <div class="row">
                    <div class="col-md-6">
                      <h6>Silabs CP2102</h6>
                      <p><a href="https://www.silabs.com/developer-tools/usb-to-uart-bridge-vcp-drivers" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-download"></i> Download Driver
                      </a></p>
                    </div>
                    <div class="col-md-6">
                      <h6>CH340</h6>
                      <p><a href="https://www.wch.cn/downloads/CH341SER_EXE.html" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-download"></i> Download Driver
                      </a></p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Troubleshooting -->
              <div class="card mb-4">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-tools"></i> 2. Troubleshooting</h5>
                </div>
                <div class="card-body">
                  <div class="accordion" id="faqAccordion">
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                          Board not detected?
                        </button>
                      </h2>
                      <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                          <ol>
                            <li>Make sure drivers are installed (see above)</li>
                            <li>Try a different USB cable (some are charge-only)</li>
                            <li>Try a different USB port</li>
                            <li>On Windows, check Device Manager for the COM port</li>
                          </ol>
                        </div>
                      </div>
                    </div>
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                          Flashing failed?
                        </button>
                      </h2>
                      <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                          <ol>
                            <li>Put the board into boot mode: Hold BOOT, press RESET, release RESET, release BOOT</li>
                            <li>Try erasing the flash first using the "Erase Flash" tab</li>
                            <li>Make sure no other program is using the serial port</li>
                            <li>Try at a lower baud rate if available</li>
                          </ol>
                        </div>
                      </div>
                    </div>
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                          How to enter boot mode?
                        </button>
                      </h2>
                      <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                          <p><strong>For ESP32:</strong></p>
                          <ol>
                            <li>Press and hold the BOOT button</li>
                            <li>Press and release the RESET (EN) button</li>
                            <li>Release the BOOT button</li>
                          </ol>
                          <p><strong>For ESP32-S3 (Xiao):</strong></p>
                          <ol>
                            <li>Hold BOOT while connecting USB</li>
                            <li>Or double-tap RESET to enter UF2 bootloader</li>
                          </ol>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Links -->
              <div class="card mb-4">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-link-45deg"></i> 3. Useful Links</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <ul class="list-unstyled">
                        <li><a href="https://openuc2.github.io" target="_blank"><i class="bi bi-book"></i> Documentation</a></li>
                        <li><a href="https://github.com/youseetoo/uc2-esp32" target="_blank"><i class="bi bi-github"></i> Firmware Source</a></li>
                        <li><a href="https://openuc2.discourse.group" target="_blank"><i class="bi bi-chat-dots"></i> Community Forum</a></li>
                      </ul>
                    </div>
                    <div class="col-md-6">
                      <ul class="list-unstyled">
                        <li><a href="./indexWebSerialTest.html" target="_blank"><i class="bi bi-terminal"></i> WebSerial Test Page</a></li>
                        <li><a href="https://espressif.github.io/esptool-js/" target="_blank"><i class="bi bi-tools"></i> Official ESPTool</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-4">
              <!-- Camera Software -->
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0"><i class="bi bi-camera"></i> Camera Software</h5>
                </div>
                <div class="card-body">
                  <p>For camera integration:</p>
                  <ul>
                    <li><a href="https://openuc2.github.io/docs/ImSwitch/DahengCamera/" target="_blank">Daheng Setup</a></li>
                    <li><a href="https://openuc2.github.io/docs/Toolboxes/DiscoveryInterferometer/SoftwareTutorial/#install-mvs-app-for-camera-utilization" target="_blank">HIK MVS Setup</a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
      <div class="container text-center">
        <p class="mb-1">
          &copy; <a href="https://openuc2.github.io/" target="_blank" class="text-white">openUC2</a>
        </p>
        <p class="text-muted small mb-0">
          Based on <a href="https://github.com/esphome/esp-web-tools" target="_blank" class="text-muted">ESP Web Tools</a>
          and <a href="https://github.com/nicola/esptool-js" target="_blank" class="text-muted">ESPTool.js</a>
        </p>
      </div>
    </footer>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
      <div class="text-center text-white">
        <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3" id="loadingText">Loading...</p>
      </div>
    </div>

    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Main Application Script -->
    <script type="module">
      // =====================================================
      // UC2 Firmware Flasher Application
      // =====================================================

      const GITHUB_REPO = 'youseetoo/uc2-esp32';
      const GITHUB_API = `https://api.github.com/repos/${GITHUB_REPO}`;
      const BINARIES_REPO = 'youseetoo/uc2-esp32-binaries';
      const CDN_BASE = `https://cdn.jsdelivr.net/gh/${BINARIES_REPO}`;
      
      // Board configurations with images and metadata
      const BOARD_CONFIG = {
        'esp32-uc2-wemos': {
          name: 'ESP32 WEMOS D1 R32',
          image: './IMAGES/esp32-uc2-wemos.jpg',
          chip: 'ESP32',
          description: 'Off-the-shelf board for use with CNC Shield v3',
          canConfig: false
        },
        'esp32-uc2-standalone-2': {
          name: 'Standalone Board V2',
          image: './IMAGES/esp32-uc2-standalone-2.png',
          chip: 'ESP32',
          description: 'UC2 Standalone PCB Version 2',
          canConfig: false
        },
        'esp32-uc2-standalone-3': {
          name: 'Standalone Board V3',
          image: './IMAGES/esp32-uc2-standalone-3.png',
          chip: 'ESP32',
          description: 'UC2 Standalone PCB Version 3',
          canConfig: false
        },
        'esp32-uc2-standalone-4': {
          name: 'Standalone Board V4',
          image: './IMAGES/esp32-uc2-v4.png',
          chip: 'ESP32',
          description: 'UC2 Standalone PCB Version 4',
          canConfig: true
        },
        'esp32-uc2-v4-can': {
          name: 'UC2 V4 CAN Master',
          image: './IMAGES/esp32-uc2-v4.png',
          chip: 'ESP32',
          description: 'UC2 V4 with CAN bus master functionality',
          canConfig: true,
          defaultCanId: 1
        },
        'esp32-uc2-v4-can-hybrid': {
          name: 'UC2 V4 CAN Hybrid',
          image: './IMAGES/esp32-uc2-v4.png',
          chip: 'ESP32',
          description: 'UC2 V4 with native and CAN motors',
          canConfig: true,
          defaultCanId: 1
        },
        'can-hat-master-v2': {
          name: 'CAN HAT Master V2',
          image: './IMAGES/esp32-uc2-v4.png',
          chip: 'ESP32',
          description: 'Raspberry Pi HAT with CAN Master',
          canConfig: true,
          defaultCanId: 1
        },
        'seeed_xiao_esp32s3': {
          name: 'Xiao ESP32S3 ODMR',
          image: 'https://quantumminilabs.de/wp-content/uploads/2025/01/cropped-Quantumminilabs_Logo.png',
          chip: 'ESP32-S3',
          description: 'Seeed Xiao ESP32S3 for ODMR applications',
          canConfig: false
        },
        'seeed_xiao_esp32s3_ledservo': {
          name: 'Xiao LED & Servo',
          image: './IMAGES/ledboard.jpg',
          chip: 'ESP32-S3',
          description: 'Xiao board for LED and servo control',
          canConfig: false
        },
        'seeed_xiao_esp32s3_ledring': {
          name: 'Xiao LED Ring',
          image: './IMAGES/esp32-uc2-ledring.jpg',
          chip: 'ESP32-S3',
          description: 'Xiao board with LED ring for brightfield',
          canConfig: true
        },
        'xiao-can-slave-motor': {
          name: 'Xiao CAN Slave Motor',
          image: './IMAGES/esp32s3-uc2-motor.jpg',
          chip: 'ESP32-S3',
          description: 'CAN slave for motor control',
          canConfig: true,
          canPresets: ['X-Axis', 'Y-Axis', 'Z-Axis', 'A-Axis']
        },
        'xiao-can-slave-galvo': {
          name: 'Xiao CAN Slave Galvo',
          image: './IMAGES/esp32s3-uc2-motor.jpg',
          chip: 'ESP32-S3',
          description: 'CAN slave for galvo mirror control',
          canConfig: true,
          defaultCanId: 15
        },
        'xiao-can-slave-laser': {
          name: 'Xiao CAN Slave Laser',
          image: './IMAGES/esp32-uc2-xiao-can-ledring.png',
          chip: 'ESP32-S3',
          description: 'CAN slave for laser control',
          canConfig: true,
          defaultCanId: 20
        },
        'xiao-can-slave-led': {
          name: 'Xiao CAN Slave LED',
          image: './IMAGES/esp32-uc2-xiao-can-ledring.png',
          chip: 'ESP32-S3',
          description: 'CAN slave for LED control',
          canConfig: true,
          defaultCanId: 30
        },
        'xiao-can-slave-illumination': {
          name: 'Xiao CAN Slave Illumination',
          image: './IMAGES/esp32-uc2-xiao-can-ledring.png',
          chip: 'ESP32-S3',
          description: 'CAN slave for LED array control',
          canConfig: true,
          defaultCanId: 30
        },
        'odmr-xiao-esp32s3': {
          name: 'ODMR Xiao ESP32S3',
          image: 'https://quantumminilabs.de/wp-content/uploads/2025/01/cropped-Quantumminilabs_Logo.png',
          chip: 'ESP32-S3',
          description: 'Quantum ODMR spectroscopy board (ESP32-S3)',
          canConfig: false
        },
        'odmr-xiao-esp32c3': {
          name: 'ODMR Xiao ESP32C3',
          image: 'https://quantumminilabs.de/wp-content/uploads/2025/01/cropped-Quantumminilabs_Logo.png',
          chip: 'ESP32-C3',
          description: 'Quantum ODMR spectroscopy board (ESP32-C3)',
          canConfig: false
        },
        'waveshare_esp32s3_ledarray': {
          name: 'Waveshare ESP32S3 Matrix',
          image: './IMAGES/waveshare.webp',
          chip: 'ESP32-S3',
          description: 'Waveshare ESP32S3 with LED matrix',
          canConfig: false
        }
      };

      // Application State
      const state = {
        releases: [],
        currentRelease: null,
        selectedBoard: null,
        serialPort: null,
        serialReader: null,
        serialWriter: null,
        isConnected: false
      };

      // DOM Elements
      const elements = {
        releaseSelect: document.getElementById('releaseSelect'),
        currentVersion: document.getElementById('currentVersion'),
        releaseDate: document.getElementById('releaseDate'),
        boardGrid: document.getElementById('boardGrid'),
        boardSearch: document.getElementById('boardSearch'),
        boardInfoCard: document.getElementById('boardInfoCard'),
        boardInfo: document.getElementById('boardInfo'),
        selectedBoardName: document.getElementById('selectedBoardName'),
        selectedBoardChip: document.getElementById('selectedBoardChip'),
        installButton: document.getElementById('installButton'),
        directLink: document.getElementById('directLink'),
        copyLinkBtn: document.getElementById('copyLinkBtn'),
        postFlashConfig: document.getElementById('postFlashConfig'),
        // Configure tab
        connectSerialBtn: document.getElementById('connectSerialBtn'),
        connectionStatus: document.getElementById('connectionStatus'),
        baudRate: document.getElementById('baudRate'),
        consoleOutput: document.getElementById('consoleOutput'),
        clearConsoleBtn: document.getElementById('clearConsoleBtn'),
        customCommand: document.getElementById('customCommand'),
        sendCommandBtn: document.getElementById('sendCommandBtn'),
        customCanId: document.getElementById('customCanId'),
        setCustomCanBtn: document.getElementById('setCustomCanBtn'),
        // Erase tab
        eraseFlashBtn: document.getElementById('eraseFlashBtn'),
        eraseProgress: document.getElementById('eraseProgress'),
        eraseProgressBar: document.getElementById('eraseProgressBar'),
        eraseStatus: document.getElementById('eraseStatus'),
        eraseConsole: document.getElementById('eraseConsole'),
        // Loading
        loadingOverlay: document.getElementById('loadingOverlay'),
        loadingText: document.getElementById('loadingText'),
        browserWarning: document.getElementById('browserWarning')
      };

      // =====================================================
      // Initialization
      // =====================================================

      async function init() {
        // Check WebSerial support
        if (!('serial' in navigator)) {
          elements.browserWarning.classList.remove('hidden');
        }

        // Parse URL parameters
        parseUrlParams();

        // Load releases from GitHub
        await loadReleases();

        // Setup event listeners
        setupEventListeners();

        // Render boards
        renderBoards();

        // Update direct link
        updateDirectLink();
      }

      function parseUrlParams() {
        const params = new URLSearchParams(window.location.search);
        
        // Firmware selection
        if (params.has('firmware')) {
          state.selectedBoard = params.get('firmware');
        }
        
        // Version selection
        if (params.has('release')) {
          state.currentRelease = params.get('release');
        }

        // Tab selection
        if (params.has('tab')) {
          const tab = params.get('tab');
          const tabBtn = document.getElementById(`${tab}-tab`);
          if (tabBtn) {
            new bootstrap.Tab(tabBtn).show();
          }
        }

        // CAN ID preset
        if (params.has('canid')) {
          elements.customCanId.value = params.get('canid');
        }
      }

      // =====================================================
      // GitHub Release Loading
      // =====================================================

      async function loadReleases() {
        try {
          showLoading('Loading firmware releases...');
          
          const response = await fetch(`${GITHUB_API}/releases`);
          if (!response.ok) throw new Error('Failed to fetch releases');
          
          const releases = await response.json();
          state.releases = releases;
          
          // Populate release dropdown
          elements.releaseSelect.innerHTML = '';
          
          // Add latest option
          const latestOpt = document.createElement('option');
          latestOpt.value = 'latest';
          latestOpt.textContent = 'Latest Stable';
          elements.releaseSelect.appendChild(latestOpt);
          
          // Add all releases
          releases.forEach(release => {
            const opt = document.createElement('option');
            opt.value = release.tag_name;
            opt.textContent = `${release.tag_name} ${release.prerelease ? '(beta)' : ''}`;
            elements.releaseSelect.appendChild(opt);
          });
          
          // Select from URL or default
          if (state.currentRelease) {
            elements.releaseSelect.value = state.currentRelease;
          }
          
          // Update version display
          updateVersionDisplay();
          
          // Log CDN info
          logToConsole('\u2713 Firmware will be loaded from jsDelivr CDN', 'success');
          logToConsole('\u2139 CDN provides CORS-enabled manifest access', 'info');
          
        } catch (error) {
          console.error('Error loading releases:', error);
          logToConsole(`Error loading releases: ${error.message}`, 'error');
          
          // Fallback to static manifest files
          elements.releaseSelect.innerHTML = '<option value="static">Local (static)</option>';
        } finally {
          hideLoading();
        }
      }

      function updateVersionDisplay() {
        const selectedValue = elements.releaseSelect.value;
        let release;
        
        if (selectedValue === 'latest' || selectedValue === 'static') {
          release = state.releases[0];
        } else {
          release = state.releases.find(r => r.tag_name === selectedValue);
        }
        
        if (release) {
          elements.currentVersion.textContent = release.tag_name;
          elements.currentVersion.className = `badge version-badge ${release.prerelease ? 'bg-warning' : 'bg-success'}`;
          elements.releaseDate.textContent = new Date(release.published_at).toLocaleDateString();
          state.currentRelease = release.tag_name;
        } else {
          elements.currentVersion.textContent = 'Static';
          elements.currentVersion.className = 'badge version-badge bg-secondary';
          elements.releaseDate.textContent = '';
        }
        
        // Update manifest URL if board is selected
        if (state.selectedBoard) {
          updateManifestUrl();
        }
      }

      // =====================================================
      // Board Rendering
      // =====================================================

      function renderBoards(filter = '') {
        elements.boardGrid.innerHTML = '';
        
        const filterLower = filter.toLowerCase();
        
        Object.entries(BOARD_CONFIG).forEach(([boardId, config]) => {
          // Apply filter
          if (filter && !config.name.toLowerCase().includes(filterLower) && 
              !boardId.toLowerCase().includes(filterLower)) {
            return;
          }
          
          const col = document.createElement('div');
          col.className = 'col';
          
          const isSelected = state.selectedBoard === boardId;
          
          col.innerHTML = `
            <div class="card board-card h-100 ${isSelected ? 'selected' : ''}" data-board="${boardId}">
              <div class="card-body text-center p-2">
                <img src="${config.image}" alt="${config.name}" class="board-img mb-2"
                     onerror="this.src='./IMAGES/placeholder.svg'">
                <h6 class="card-title mb-1" style="font-size: 0.85rem;">${config.name}</h6>
                <span class="badge bg-secondary" style="font-size: 0.7rem;">${config.chip}</span>
                ${config.canConfig ? '<span class="badge bg-info ms-1" style="font-size: 0.7rem;">CAN</span>' : ''}
              </div>
            </div>
          `;
          
          col.querySelector('.board-card').addEventListener('click', () => selectBoard(boardId));
          elements.boardGrid.appendChild(col);
        });
        
        // If a board was preselected from URL, select it
        if (state.selectedBoard && !filter) {
          selectBoard(state.selectedBoard);
        }
      }

      function selectBoard(boardId) {
        // Update state
        state.selectedBoard = boardId;
        const config = BOARD_CONFIG[boardId];
        
        // Update visual selection
        document.querySelectorAll('.board-card').forEach(card => {
          card.classList.toggle('selected', card.dataset.board === boardId);
        });
        
        // Update sidebar
        elements.selectedBoardName.textContent = config ? config.name : boardId;
        elements.selectedBoardChip.textContent = config ? config.chip : '';
        
        // Enable install button
        const activateBtn = elements.installButton.querySelector('button[slot="activate"]');
        if (activateBtn) {
          activateBtn.disabled = false;
        }
        
        // Update manifest URL
        updateManifestUrl();
        
        // Show board info
        if (config) {
          showBoardInfo(boardId, config);
        }
        
        // Update direct link
        updateDirectLink();
      }

      function showBoardInfo(boardId, config) {
        elements.boardInfoCard.classList.remove('hidden');
        
        let canConfigHtml = '';
        if (config.canConfig) {
          canConfigHtml = `
            <div class="mt-3">
              <h6><i class="bi bi-diagram-3"></i> CAN Configuration</h6>
              <p class="text-muted small">This board supports CAN bus. Configure after flashing in the "Configure" tab.</p>
              ${config.defaultCanId ? `<p>Default CAN ID: <strong>${config.defaultCanId}</strong></p>` : ''}
            </div>
          `;
        }
        
        let externalRepoHtml = '';
        if (config.externalRepo) {
          externalRepoHtml = `
            <div class="mt-3">
              <h6><i class="bi bi-github"></i> External Repository</h6>
              <p class="text-muted small">
                This firmware is built from: 
                <a href="${config.externalRepo}" target="_blank" class="text-decoration-none">
                  ${config.externalRepo.split('/').slice(-2).join('/')}
                  <i class="bi bi-box-arrow-up-right"></i>
                </a>
              </p>
            </div>
          `;
        }
        
        elements.boardInfo.innerHTML = `
          <div class="row">
            <div class="col-md-4 text-center">
              <img src="${config.image}" alt="${config.name}" style="max-width: 150px;">
            </div>
            <div class="col-md-8">
              <h5>${config.name}</h5>
              <p class="text-muted">${config.description}</p>
              <p><strong>Chip:</strong> ${config.chip}</p>
              ${canConfigHtml}
              ${externalRepoHtml}
            </div>
          </div>
        `;
      }

      function updateManifestUrl() {
        if (!state.selectedBoard) return;
        
        const boardConfig = BOARD_CONFIG[state.selectedBoard];
        let manifestUrl;
        let releaseTag = state.currentRelease;
        
        // Handle 'latest' release selection
        if (releaseTag === 'latest') {
          const latestRelease = state.releases.find(r => !r.prerelease);
          releaseTag = latestRelease ? latestRelease.tag_name : state.releases[0]?.tag_name;
        }
        
        // Check if board is from external repo (ODMR firmware)
        if (boardConfig.manifestPath) {
          // Use local path for ODMR firmware uploaded by workflow
          manifestUrl = `${window.location.origin}${boardConfig.manifestPath}${state.selectedBoard}-manifest.json`;
          console.log('Using external repo manifest:', manifestUrl);
        } else if (releaseTag) {
          // Use jsDelivr CDN from mirror repository (CORS-enabled)
          manifestUrl = `${CDN_BASE}@${releaseTag}/${state.selectedBoard}-manifest.json`;
          console.log('Using jsDelivr CDN manifest:', manifestUrl);
          logToConsole(`\u2713 Loading from CDN: ${releaseTag}/${state.selectedBoard}`, 'success');
        } else {
          // Fallback to static files
          manifestUrl = `./static/firmware_build/${state.selectedBoard}-manifest.json`;
          console.log('Using static manifest:', manifestUrl);
        }
        
        elements.installButton.manifest = manifestUrl;
        console.log('Final manifest URL:', manifestUrl);
      }

      function updateDirectLink() {
        const params = new URLSearchParams();
        
        if (state.selectedBoard) {
          params.set('firmware', state.selectedBoard);
        }
        if (state.currentRelease && state.currentRelease !== 'latest') {
          params.set('release', state.currentRelease);
        }
        
        const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        elements.directLink.value = url;
        
        // Log CDN manifest URL for reference
        if (state.selectedBoard && state.currentRelease) {
          let releaseTag = state.currentRelease;
          if (releaseTag === 'latest') {
            const latestRelease = state.releases.find(r => !r.prerelease);
            releaseTag = latestRelease ? latestRelease.tag_name : state.releases[0]?.tag_name;
          }
          if (releaseTag) {
            const cdnUrl = `${CDN_BASE}@${releaseTag}/${state.selectedBoard}-manifest.json`;
            console.log('CDN Manifest URL:', cdnUrl);
          }
        }
      }

      // =====================================================
      // Serial Communication
      // =====================================================

      async function connectSerial() {
        try {
          if (state.isConnected) {
            await disconnectSerial();
            return;
          }
          
          const baudRate = parseInt(elements.baudRate.value);
          state.serialPort = await navigator.serial.requestPort();
          await state.serialPort.open({ baudRate });
          
          // Setup reader
          const decoder = new TextDecoderStream();
          state.serialPort.readable.pipeTo(decoder.writable);
          state.serialReader = decoder.readable.getReader();
          
          // Setup writer
          const encoder = new TextEncoderStream();
          encoder.readable.pipeTo(state.serialPort.writable);
          state.serialWriter = encoder.writable.getWriter();
          
          state.isConnected = true;
          updateConnectionStatus(true);
          
          // Start reading
          readSerialLoop();
          
          logToConsole('Connected to serial port', 'success');
          
        } catch (error) {
          console.error('Serial connection error:', error);
          logToConsole(`Connection error: ${error.message}`, 'error');
          state.isConnected = false;
          updateConnectionStatus(false);
        }
      }

      async function disconnectSerial() {
        try {
          if (state.serialReader) {
            await state.serialReader.cancel();
            state.serialReader = null;
          }
          if (state.serialWriter) {
            await state.serialWriter.close();
            state.serialWriter = null;
          }
          if (state.serialPort) {
            await state.serialPort.close();
            state.serialPort = null;
          }
          
          state.isConnected = false;
          updateConnectionStatus(false);
          logToConsole('Disconnected from serial port', 'info');
          
        } catch (error) {
          console.error('Disconnect error:', error);
        }
      }

      async function readSerialLoop() {
        try {
          while (state.isConnected && state.serialReader) {
            const { value, done } = await state.serialReader.read();
            if (done) break;
            if (value) {
              logToConsole(value, 'info');
            }
          }
        } catch (error) {
          if (error.name !== 'NetworkError') {
            console.error('Read error:', error);
            logToConsole(`Read error: ${error.message}`, 'error');
          }
        }
      }

      async function sendSerialCommand(command) {
        if (!state.isConnected || !state.serialWriter) {
          logToConsole('Not connected to serial port', 'error');
          return false;
        }
        
        try {
          await state.serialWriter.write(command + '\n');
          logToConsole(`> ${command}`, 'success');
          return true;
        } catch (error) {
          console.error('Send error:', error);
          logToConsole(`Send error: ${error.message}`, 'error');
          return false;
        }
      }

      async function setCanId(address) {
        const command = JSON.stringify({ task: '/can_act', address: parseInt(address) });
        return await sendSerialCommand(command);
      }

      function updateConnectionStatus(connected) {
        elements.connectionStatus.textContent = connected ? 'Connected' : 'Disconnected';
        elements.connectionStatus.className = `ms-2 badge ${connected ? 'bg-success' : 'bg-secondary'}`;
        elements.connectSerialBtn.innerHTML = connected ? 
          '<i class="bi bi-plug-fill"></i> Disconnect' : 
          '<i class="bi bi-plug"></i> Connect';
      }

      // =====================================================
      // Console Logging
      // =====================================================

      function logToConsole(message, type = 'info') {
        const console = elements.consoleOutput;
        const line = document.createElement('div');
        line.className = type;
        line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        console.appendChild(line);
        console.scrollTop = console.scrollHeight;
      }

      function clearConsole() {
        elements.consoleOutput.innerHTML = '<span class="info">Console cleared.</span>';
      }

      // =====================================================
      // Erase Flash
      // =====================================================

      async function eraseFlash() {
        const eraseType = document.querySelector('input[name="eraseType"]:checked').value;
        
        try {
          elements.eraseProgress.classList.remove('hidden');
          elements.eraseFlashBtn.disabled = true;
          logToEraseConsole('Requesting serial port...', 'info');
          
          const port = await navigator.serial.requestPort();
          await port.open({ baudRate: 115200 });
          
          logToEraseConsole('Connected. Starting erase...', 'info');
          updateEraseProgress(10, 'Connecting to ESP32...');
          
          // Check if esptool is loaded, try both window and esptoolPackage
          let Transport = window.Transport;
          let ESPLoader = window.ESPLoader;
          
          if (!Transport || !ESPLoader) {
            if (typeof esptoolPackage !== 'undefined') {
              Transport = esptoolPackage.Transport;
              ESPLoader = esptoolPackage.ESPLoader;
              // Cache for future use
              window.Transport = Transport;
              window.ESPLoader = ESPLoader;
            } else {
              throw new Error('ESPTool.js not loaded. Please refresh the page.');
            }
          }
          
          // Use esptool.js for erasing
          const transport = new Transport(port);
          const loader = new ESPLoader(transport, 115200);
          
          updateEraseProgress(20, 'Syncing...');
          await loader.main_fn();
          
          updateEraseProgress(40, 'Erasing flash...');
          logToEraseConsole(`Erasing ${eraseType === 'all' ? 'entire flash' : 'NVS partition'}...`, 'warning');
          
          if (eraseType === 'all') {
            await loader.erase_flash();
          } else {
            // Erase NVS partition (typically at 0x9000, size 0x5000)
            await loader.erase_region(0x9000, 0x5000);
          }
          
          updateEraseProgress(100, 'Erase complete!');
          logToEraseConsole('Flash erased successfully!', 'success');
          
          await port.close();
          
        } catch (error) {
          console.error('Erase error:', error);
          logToEraseConsole(`Error: ${error.message}`, 'error');
          updateEraseProgress(0, 'Erase failed');
        } finally {
          elements.eraseFlashBtn.disabled = false;
        }
      }

      function logToEraseConsole(message, type = 'info') {
        const console = elements.eraseConsole;
        const line = document.createElement('div');
        line.className = type;
        line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        console.appendChild(line);
        console.scrollTop = console.scrollHeight;
      }

      function updateEraseProgress(percent, status) {
        elements.eraseProgressBar.style.width = `${percent}%`;
        elements.eraseStatus.textContent = status;
      }

      // =====================================================
      // Loading Overlay
      // =====================================================

      function showLoading(text = 'Loading...') {
        elements.loadingText.textContent = text;
        elements.loadingOverlay.classList.remove('hidden');
      }

      function hideLoading() {
        elements.loadingOverlay.classList.add('hidden');
      }

      // =====================================================
      // Event Listeners
      // =====================================================

      function setupEventListeners() {
        // Release selection
        elements.releaseSelect.addEventListener('change', () => {
          updateVersionDisplay();
        });
        
        // Board search
        elements.boardSearch.addEventListener('input', (e) => {
          renderBoards(e.target.value);
        });
        
        // Copy link button
        elements.copyLinkBtn.addEventListener('click', () => {
          elements.directLink.select();
          navigator.clipboard.writeText(elements.directLink.value);
          elements.copyLinkBtn.innerHTML = '<i class="bi bi-check"></i>';
          setTimeout(() => {
            elements.copyLinkBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
          }, 2000);
        });
        
        // Serial connection
        elements.connectSerialBtn.addEventListener('click', connectSerial);
        
        // Clear console
        elements.clearConsoleBtn.addEventListener('click', clearConsole);
        
        // Send custom command
        elements.sendCommandBtn.addEventListener('click', () => {
          const cmd = elements.customCommand.value.trim();
          if (cmd) {
            sendSerialCommand(cmd);
            elements.customCommand.value = '';
          }
        });
        
        // Enter key for command input
        elements.customCommand.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            elements.sendCommandBtn.click();
          }
        });
        
        // CAN presets
        document.querySelectorAll('.can-preset').forEach(preset => {
          preset.addEventListener('click', () => {
            document.querySelectorAll('.can-preset').forEach(p => p.classList.remove('selected'));
            preset.classList.add('selected');
            const address = preset.dataset.address;
            setCanId(address);
          });
        });
        
        // Custom CAN ID
        elements.setCustomCanBtn.addEventListener('click', () => {
          const id = elements.customCanId.value;
          if (id) {
            setCanId(id);
          }
        });
        
        // Quick commands
        document.querySelectorAll('.quick-cmd').forEach(btn => {
          btn.addEventListener('click', () => {
            sendSerialCommand(btn.dataset.cmd);
          });
        });
        
        // Erase flash
        elements.eraseFlashBtn.addEventListener('click', eraseFlash);
        
        // ESP Web Tools install events
        elements.installButton.addEventListener('state-changed', (e) => {
          console.log('Install state:', e.detail);
          
          if (e.detail.state === 'finished' && elements.postFlashConfig.checked) {
            // Switch to configure tab after successful flash
            const configTab = document.getElementById('configure-tab');
            new bootstrap.Tab(configTab).show();
            
            // Show notification
            logToConsole('Firmware flashed successfully! Connect to configure the device.', 'success');
          }
        });
      }

      // =====================================================
      // Start Application
      // =====================================================

      init();
    </script>
  </body>
</html>
