<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NV Experimente - Justage des Aufbaus</title>

  <!-- Bootstrap 5 -->
  <!-- Bootstrap 5 -->
  <script>
    // Automatic Bootstrap loading: Use CDN for development, local for ESP32
    (function() {
      const isLocalDevice = window.location.hostname === '192.168.4.1' || 
                           window.location.hostname.includes('ODMR_') || 
                           window.location.protocol === 'file:';
      
      if (isLocalDevice) {
        // Load from ESP32 local server
        document.write('<link href="/bootstrap.min.css" rel="stylesheet">');
      } else {
        // Load from CDN for development
        document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
      }
    })();
  </script>

  <!-- Brand palette ---------------------------------------------------------->
  <style>
    :root{
      --uc2-blue:       #023773;  /* primary   */
      --uc2-green:      #85b918;  /* success   */
      --uc2-turquoise:  #1f9c7c;  /* info      */
      --uc2-light:      #faf9f9;  /* body bg   */
      --uc2-grey:       #999999;  /* muted txt */
    }
    body           { background: var(--uc2-light); color: var(--uc2-grey); }
    h1,h2,h3,h4,h5 { color: var(--uc2-blue); }
    /* navbar */
    .navbar         { background: var(--uc2-blue); }
    .navbar-brand,
    .navbar-nav .nav-link { color:#fff; }
    .navbar-nav .nav-link.active{ color: var(--uc2-green); }
    .navbar-nav .nav-link:hover{ color: var(--uc2-turquoise); }
    /* links in text */
    a{ color: var(--uc2-blue); }
    a:hover{ color: var(--uc2-turquoise); }
    footer{ background: var(--uc2-blue); color:#fff; }
  </style>
</head>

<body>
  <!-- ‚ñë‚ñë Navbar ‚ñë‚ñë----------------------------------------------------------- -->
  <nav class="navbar navbar-expand-lg shadow-sm mb-4">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">NV-Experimente</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#nvNav" aria-controls="nvNav" aria-expanded="false">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="nvNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html" data-lang-key="nav_start">Start</a></li>
          <li class="nav-item"><a class="nav-link" href="messung.html" data-lang-key="nav_measurement_device">Messung (on Device)</a></li>
          <li class="nav-item" id="webSerialNavItem"><a class="nav-link" href="messung_webserial.html" data-lang-key="nav_measurement_webserial">Messung (WebSerial)</a></li>
          <li class="nav-item"><a class="nav-link active" href="justage.html" data-lang-key="nav_alignment">Justage</a></li>
          <li class="nav-item"><a class="nav-link" href="infos.html" data-lang-key="nav_info">Weitere Infos</a></li>
                  <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="langDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              üåê DE
            </a>
            <ul class="dropdown-menu" aria-labelledby="langDropdown">
              <li><a class="dropdown-item" href="#" onclick="setLanguage('de'); return false;">üá©üá™ Deutsch</a></li>
              <li><a class="dropdown-item" href="#" onclick="setLanguage('en'); return false;">üá∫üá∏ English</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ‚ñë‚ñë Main content ‚ñë‚ñë------------------------------------------------------ -->
  <main class="container">
    <section class="mb-5">
      <h1 class="display-5 mb-3">Justage des Aufbaus</h1>
      <div class="row">
        <div class="col-md-8">
          <p class="lead">Live-√úberwachung der Photodioden-Intensit√§t zur Justage des optischen Pfads</p>
          
          <div class="card mb-4">
            <div class="card-header">
              <h3>Photodioden-Intensit√§t (Live)</h3>
            </div>
            <div class="card-body text-center">
              <div class="row">
                <div class="col-md-6">
                  <h4>Aktueller Wert</h4>
                  <div class="display-4 text-primary" id="intensityValue">---</div>
                  <small class="text-muted">ADC Units</small>
                </div>
                <div class="col-md-6">
                  <h4>Intensit√§ts-Anzeige</h4>
                  <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar bg-info" role="progressbar" id="intensityBar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  <div>
                    <button id="startIntensity" class="btn btn-success">Start √úberwachung</button>
                    <button id="stopIntensity" class="btn btn-danger" disabled>Stop √úberwachung</button>
                  </div>
                </div>
              </div>
              
              <div class="mt-4">
                <h5>Status: <span id="alignmentStatus" class="badge bg-secondary">Bereit</span></h5>
                <p class="text-muted">Justieren Sie den optischen Pfad f√ºr maximale Intensit√§t</p>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h4>Justage-Anleitung</h4>
            </div>
            <div class="card-body">
              <ol>
                <li>Klicken Sie auf "Start √úberwachung" um die Live-Anzeige zu aktivieren</li>
                <li>Die LED am Board wird blau leuchten um zu zeigen, dass die Intensit√§tsmessung aktiv ist</li>
                <li>Justieren Sie die optischen Komponenten (Laser, Linsen, Spiegel)</li>
                <li>Beobachten Sie die Intensit√§tswerte und streben Sie maximale Werte an</li>
                <li>Klicken Sie auf "Stop √úberwachung" wenn die Justage abgeschlossen ist</li>
              </ol>
            </div>
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>Messbereich</h5>
            </div>
            <div class="card-body">
              <p><strong>Minimal:</strong> 0</p>
              <p><strong>Maximal:</strong> 65535</p>
              <p><strong>Optimal:</strong> > 50000</p>
            </div>
          </div>
          
          <div class="card mt-3">
            <div class="card-header">
              <h5>Sensor-Einstellungen</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="gainSelect" class="form-label">Verst√§rkung (Gain)</label>
                <select class="form-select" id="gainSelect">
                  <option value="0x00">Low (1x)</option>
                  <option value="0x10">Medium (25x)</option>
                  <option value="0x20">High (428x)</option>
                  <option value="0x30" selected>Max (9876x)</option>
                </select>
              </div>
              
              <div class="mb-3">
                <label for="integrationSelect" class="form-label">Integrationszeit</label>
                <select class="form-select" id="integrationSelect">
                  <option value="0x00" selected>100 ms</option>
                  <option value="0x01">200 ms</option>
                  <option value="0x02">300 ms</option>
                  <option value="0x03">400 ms</option>
                  <option value="0x04">500 ms</option>
                  <option value="0x05">600 ms</option>
                </select>
              </div>
              
              <button class="btn btn-primary w-100" id="applySettings">Einstellungen anwenden</button>
              <div id="settingsStatus" class="mt-2 small text-muted"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ‚ñë‚ñë Footer ‚ñë‚ñë----------------------------------------------------------- -->
  <footer class="py-3 mt-auto">
    <div class="container text-center small">
      <div>Uni M√ºnster ¬∑ openUC2 GmbH ‚Äì <a class="text-white text-decoration-none" href="mailto:hello@openuc2.com">hello@openuc2.com</a></div>
      <div class="mt-1" id="versionInfo" style="opacity: 0.7; font-size: 0.85em;">Loading version...</div>
    </div>
  </footer>

  <script src="/bootstrap.bundle.min.js"></script>
  
  <script>
    let intensityInterval = null;
    let isMonitoring = false;
    
    const intensityValue = document.getElementById('intensityValue');
    const intensityBar = document.getElementById('intensityBar');
    const alignmentStatus = document.getElementById('alignmentStatus');
    const startBtn = document.getElementById('startIntensity');
    const stopBtn = document.getElementById('stopIntensity');
    const gainSelect = document.getElementById('gainSelect');
    const integrationSelect = document.getElementById('integrationSelect');
    const applySettingsBtn = document.getElementById('applySettings');
    const settingsStatus = document.getElementById('settingsStatus');
    
    // Load current TSL settings on page load
    function loadTSLSettings() {
      fetch('/tsl/settings')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('TSL settings endpoint not available');
          }
          return response.json();
        })
        .then(data => {
          gainSelect.value = '0x' + data.gain.toString(16).toUpperCase().padStart(2, '0');
          integrationSelect.value = '0x' + data.integration_time.toString(16).toUpperCase().padStart(2, '0');
          settingsStatus.textContent = 'Aktuelle Einstellungen geladen';
          settingsStatus.className = 'mt-2 small text-success';
        })
        .catch(error => {
          console.error('Error loading TSL settings:', error);
          settingsStatus.textContent = 'TSL Einstellungen nicht verf√ºgbar';
          settingsStatus.className = 'mt-2 small text-warning';
        });
    }
    
    // Apply TSL settings
    function applyTSLSettings() {
      const gain = parseInt(gainSelect.value);
      const integrationTime = parseInt(integrationSelect.value);
      
      settingsStatus.textContent = 'Einstellungen werden angewendet...';
      settingsStatus.className = 'mt-2 small text-info';
      
      // Set gain
      fetch('/tsl/gain?gain=' + gain, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          // Set integration time
          return fetch('/tsl/integration_time?integration_time=' + integrationTime, { method: 'POST' });
        })
        .then(response => response.json())
        .then(data => {
          settingsStatus.textContent = 'Einstellungen erfolgreich angewendet';
          settingsStatus.className = 'mt-2 small text-success';
        })
        .catch(error => {
          console.error('Error applying TSL settings:', error);
          settingsStatus.textContent = 'Fehler beim Anwenden der Einstellungen';
          settingsStatus.className = 'mt-2 small text-danger';
        });
    }
    
    function updateIntensity() {
      fetch('/intensity')
        .then(response => response.json())
        .then(data => {
          const intensity = data.intensity;
          intensityValue.textContent = intensity;
          
          // Update progress bar (assuming max value of 65535)
          const percentage = Math.min((intensity / 65535) * 100, 100);
          intensityBar.style.width = percentage + '%';
          intensityBar.setAttribute('aria-valuenow', percentage);
          
          // Update status based on intensity
          if (intensity > 50000) {
            alignmentStatus.textContent = 'Optimal';
            alignmentStatus.className = 'badge bg-success';
            intensityBar.className = 'progress-bar bg-success';
          } else if (intensity > 20000) {
            alignmentStatus.textContent = 'Gut';
            alignmentStatus.className = 'badge bg-warning';
            intensityBar.className = 'progress-bar bg-warning';
          } else {
            alignmentStatus.textContent = 'Justage erforderlich';
            alignmentStatus.className = 'badge bg-danger';
            intensityBar.className = 'progress-bar bg-danger';
          }
        })
        .catch(error => {
          console.error('Error fetching intensity:', error);
          intensityValue.textContent = 'Fehler';
        });
    }
    
    function startMonitoring() {
      if (!isMonitoring) {
        isMonitoring = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        alignmentStatus.textContent = '√úberwachung aktiv';
        alignmentStatus.className = 'badge bg-info';
        
        // Update immediately
        updateIntensity();
        
        // Set interval for continuous updates
        intensityInterval = setInterval(updateIntensity, 500); // Update every 500ms
      }
    }
    
    function stopMonitoring() {
      if (isMonitoring) {
        isMonitoring = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        alignmentStatus.textContent = 'Bereit';
        alignmentStatus.className = 'badge bg-secondary';
        
        if (intensityInterval) {
          clearInterval(intensityInterval);
          intensityInterval = null;
        }
      }
    }
    
    // Event listeners
    startBtn.addEventListener('click', startMonitoring);
    stopBtn.addEventListener('click', stopMonitoring);
    applySettingsBtn.addEventListener('click', applyTSLSettings);
    
    // Load settings on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadTSLSettings();
    });
    
    // Handle page visibility changes
    document.addEventListener('visibilitychange', function() {
      if (document.hidden && isMonitoring) {
        stopMonitoring();
      }
    });
    
    // Handle beforeunload
    window.addEventListener('beforeunload', function() {
      if (isMonitoring) {
        stopMonitoring();
      }
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Fetch and display version information
      fetch('/version')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Version endpoint not available');
          }
          return response.json();
        })
        .then(data => {
          const versionInfo = document.getElementById('versionInfo');
          if (versionInfo) {
            versionInfo.textContent = `v${data.version} | Build: ${data.build_date} | ${data.git_hash}`;
          }
        })
        .catch(error => {
          console.error('Error fetching version:', error);
          const versionInfo = document.getElementById('versionInfo');
          if (versionInfo) {
            versionInfo.textContent = 'Version: ESP32 ODMR Server';
          }
        });
    });
  </script>

  <script>
    // Multi-language support
    const translations = {
      de: {
        "nav_start": "Start",
        "nav_measurement_device": "Messung (on Device)",
        "nav_measurement_webserial": "Messung (WebSerial)",
        "nav_alignment": "Justage",
        "nav_info": "Weitere Infos",
        "title": "NV Experimente - Justage",
        "page_title": "Photodioden-Justage",
        "intensity_monitor": "Intensit√§ts-Monitor",
        "start_monitoring": "Monitoring starten",
        "stop_monitoring": "Monitoring stoppen",
        "current_intensity": "Aktuelle Intensit√§t"
      },
      en: {
        "nav_start": "Start",
        "nav_measurement_device": "Measurement (on Device)",
        "nav_measurement_webserial": "Measurement (WebSerial)",
        "nav_alignment": "Alignment",
        "nav_info": "More Info",
        "title": "NV Experiments - Alignment",
        "page_title": "Photodiode Alignment",
        "intensity_monitor": "Intensity Monitor",
        "start_monitoring": "Start Monitoring",
        "stop_monitoring": "Stop Monitoring",
        "current_intensity": "Current Intensity"
      }
    };
    
    function setLanguage(lang) {
      localStorage.setItem('language', lang);
      updateLanguage(lang);
      
      // Update dropdown display
      const langDropdown = document.getElementById('langDropdown');
      if (langDropdown) {
        langDropdown.innerHTML = `üåê ${lang.toUpperCase()}`;
      }
    }
    
    function updateLanguage(lang) {
      const elements = document.querySelectorAll('[data-lang-key]');
      elements.forEach(element => {
        const key = element.getAttribute('data-lang-key');
        if (translations[lang] && translations[lang][key]) {
          element.textContent = translations[lang][key];
        }
      });
      
      // Update title
      if (translations[lang] && translations[lang].title) {
        document.title = translations[lang].title;
      }
    }
    
    // Initialize language on page load
    document.addEventListener('DOMContentLoaded', function() {
      const savedLang = localStorage.getItem('language') || 'de';
      setLanguage(savedLang);
      
      // Hide WebSerial navigation item if on ESP32
      const isLocalDevice = window.location.hostname === '192.168.4.1' || 
                           window.location.hostname.includes('ODMR_') || 
                           window.location.protocol === 'file:';
      
      if (isLocalDevice) {
        const webSerialNavItem = document.getElementById('webSerialNavItem');
        if (webSerialNavItem) {
          webSerialNavItem.style.display = 'none';
        }
      }
      
      // Fetch and display version information
      fetch('/version')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Version endpoint not available');
          }
          return response.json();
        })
        .then(data => {
          const versionInfo = document.getElementById('versionInfo');
          if (versionInfo) {
            versionInfo.textContent = `v${data.version} | Build: ${data.build_date} | ${data.git_hash}`;
          }
        })
        .catch(error => {
          console.error('Error fetching version:', error);
          const versionInfo = document.getElementById('versionInfo');
          if (versionInfo) {
            versionInfo.textContent = 'Version: ESP32 ODMR Server';
          }
        });
    });
  </script>
</body>
</html>