<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NV Experimente - Justage des Aufbaus</title>

  <!-- Bootstrap 5 -->
  <!-- Bootstrap 5 -->
  <script>
    // Automatic Bootstrap loading: Use CDN for development, local for ESP32
    (function() {
      const isLocalDevice = window.location.hostname === '192.168.4.1' || 
                           window.location.hostname.includes('ODMR_') || 
                           window.location.protocol === 'file:';
      
      if (isLocalDevice) {
        // Load from ESP32 local server
        document.write('<link href="/bootstrap.min.css" rel="stylesheet">');
      } else {
        // Load from CDN for development
        document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
      }
    })();
  </script>

  <!-- Brand palette ---------------------------------------------------------->
  <style>
    :root{
      --uc2-blue:       #023773;  /* primary   */
      --uc2-green:      #85b918;  /* success   */
      --uc2-turquoise:  #1f9c7c;  /* info      */
      --uc2-light:      #faf9f9;  /* body bg   */
      --uc2-grey:       #999999;  /* muted txt */
    }
    body           { background: var(--uc2-light); color: var(--uc2-grey); }
    h1,h2,h3,h4,h5 { color: var(--uc2-blue); }
    /* navbar */
    .navbar         { background: var(--uc2-blue); }
    .navbar-brand,
    .navbar-nav .nav-link { color:#fff; }
    .navbar-nav .nav-link.active{ color: var(--uc2-green); }
    .navbar-nav .nav-link:hover{ color: var(--uc2-turquoise); }
    /* links in text */
    a{ color: var(--uc2-blue); }
    a:hover{ color: var(--uc2-turquoise); }
    footer{ background: var(--uc2-blue); color:#fff; }
  </style>
</head>

<body>
  <!-- ░░ Navbar ░░----------------------------------------------------------- -->
  <nav class="navbar navbar-expand-lg shadow-sm mb-4">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">NV-Experimente</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#nvNav" aria-controls="nvNav" aria-expanded="false">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="nvNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Start</a></li>
          <li class="nav-item"><a class="nav-link" href="messung.html">Messung (on Device)</a></li>
          <li class="nav-item"><a class="nav-link" href="messung_webserial.html">Messung (WebSerial)</a></li>
          <li class="nav-item"><a class="nav-link active" href="justage.html">Justage (folgt)</a></li>
          <li class="nav-item"><a class="nav-link" href="infos.html">Weitere Infos</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ░░ Main content ░░------------------------------------------------------ -->
  <main class="container">
    <section class="mb-5">
      <h1 class="display-5 mb-3">Justage des Aufbaus</h1>
      <div class="row">
        <div class="col-md-8">
          <p class="lead">Live-Überwachung der Photodioden-Intensität zur Justage des optischen Pfads</p>
          
          <div class="card mb-4">
            <div class="card-header">
              <h3>Photodioden-Intensität (Live)</h3>
            </div>
            <div class="card-body text-center">
              <div class="row">
                <div class="col-md-6">
                  <h4>Aktueller Wert</h4>
                  <div class="display-4 text-primary" id="intensityValue">---</div>
                  <small class="text-muted">ADC Units</small>
                </div>
                <div class="col-md-6">
                  <h4>Intensitäts-Anzeige</h4>
                  <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar bg-info" role="progressbar" id="intensityBar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  <div>
                    <button id="startIntensity" class="btn btn-success">Start Überwachung</button>
                    <button id="stopIntensity" class="btn btn-danger" disabled>Stop Überwachung</button>
                  </div>
                </div>
              </div>
              
              <div class="mt-4">
                <h5>Status: <span id="alignmentStatus" class="badge bg-secondary">Bereit</span></h5>
                <p class="text-muted">Justieren Sie den optischen Pfad für maximale Intensität</p>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h4>Justage-Anleitung</h4>
            </div>
            <div class="card-body">
              <ol>
                <li>Klicken Sie auf "Start Überwachung" um die Live-Anzeige zu aktivieren</li>
                <li>Die LED am Board wird blau leuchten um zu zeigen, dass die Intensitätsmessung aktiv ist</li>
                <li>Justieren Sie die optischen Komponenten (Laser, Linsen, Spiegel)</li>
                <li>Beobachten Sie die Intensitätswerte und streben Sie maximale Werte an</li>
                <li>Klicken Sie auf "Stop Überwachung" wenn die Justage abgeschlossen ist</li>
              </ol>
            </div>
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>Messbereich</h5>
            </div>
            <div class="card-body">
              <p><strong>Minimal:</strong> 0</p>
              <p><strong>Maximal:</strong> 65535</p>
              <p><strong>Optimal:</strong> > 50000</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ░░ Footer ░░----------------------------------------------------------- -->
  <footer class="py-3 mt-auto">
    <div class="container text-center small">
      Uni Münster · openUC2 GmbH – <a class="text-white text-decoration-none" href="mailto:hello@openuc2.com">hello@openuc2.com</a>
    </div>
  </footer>

  <script src="/bootstrap.bundle.min.js"></script>
  
  <script>
    let intensityInterval = null;
    let isMonitoring = false;
    
    const intensityValue = document.getElementById('intensityValue');
    const intensityBar = document.getElementById('intensityBar');
    const alignmentStatus = document.getElementById('alignmentStatus');
    const startBtn = document.getElementById('startIntensity');
    const stopBtn = document.getElementById('stopIntensity');
    
    function updateIntensity() {
      fetch('/intensity')
        .then(response => response.json())
        .then(data => {
          const intensity = data.intensity;
          intensityValue.textContent = intensity;
          
          // Update progress bar (assuming max value of 65535)
          const percentage = Math.min((intensity / 65535) * 100, 100);
          intensityBar.style.width = percentage + '%';
          intensityBar.setAttribute('aria-valuenow', percentage);
          
          // Update status based on intensity
          if (intensity > 50000) {
            alignmentStatus.textContent = 'Optimal';
            alignmentStatus.className = 'badge bg-success';
            intensityBar.className = 'progress-bar bg-success';
          } else if (intensity > 20000) {
            alignmentStatus.textContent = 'Gut';
            alignmentStatus.className = 'badge bg-warning';
            intensityBar.className = 'progress-bar bg-warning';
          } else {
            alignmentStatus.textContent = 'Justage erforderlich';
            alignmentStatus.className = 'badge bg-danger';
            intensityBar.className = 'progress-bar bg-danger';
          }
        })
        .catch(error => {
          console.error('Error fetching intensity:', error);
          intensityValue.textContent = 'Fehler';
        });
    }
    
    function startMonitoring() {
      if (!isMonitoring) {
        isMonitoring = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        alignmentStatus.textContent = 'Überwachung aktiv';
        alignmentStatus.className = 'badge bg-info';
        
        // Update immediately
        updateIntensity();
        
        // Set interval for continuous updates
        intensityInterval = setInterval(updateIntensity, 500); // Update every 500ms
      }
    }
    
    function stopMonitoring() {
      if (isMonitoring) {
        isMonitoring = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        alignmentStatus.textContent = 'Bereit';
        alignmentStatus.className = 'badge bg-secondary';
        
        if (intensityInterval) {
          clearInterval(intensityInterval);
          intensityInterval = null;
        }
      }
    }
    
    // Event listeners
    startBtn.addEventListener('click', startMonitoring);
    stopBtn.addEventListener('click', stopMonitoring);
    
    // Handle page visibility changes
    document.addEventListener('visibilitychange', function() {
      if (document.hidden && isMonitoring) {
        stopMonitoring();
      }
    });
    
    // Handle beforeunload
    window.addEventListener('beforeunload', function() {
      if (isMonitoring) {
        stopMonitoring();
      }
    });
  </script>
</body>
</html>