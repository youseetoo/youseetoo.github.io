<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NV Experimente - Messung durchf√ºhren</title>

  <!-- Bootstrap 5 -->
  <script>
    // Automatic Bootstrap loading: Use CDN for development, local for ESP32
    (function() {
      const isLocalDevice = window.location.hostname === '192.168.4.1' || 
                           window.location.hostname.includes('ODMR_') || 
                           window.location.protocol === 'file:';
      
      if (isLocalDevice) {
        // Load from ESP32 local server
        document.write('<link href="/bootstrap.min.css" rel="stylesheet">');
      } else {
        // Load from CDN for development
        document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
        document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">');
      }
    })();
  </script>

  <!-- Brand palette ---------------------------------------------------------->
  <style>
    :root{
      --uc2-blue:       #023773;  /* primary   */
      --uc2-green:      #85b918;  /* success   */
      --uc2-turquoise:  #1f9c7c;  /* info      */
      --uc2-light:      #faf9f9;  /* body bg   */
      --uc2-grey:       #999999;  /* muted txt */
    }
    body           { background: var(--uc2-light); color: var(--uc2-grey); }
    h1,h2,h3,h4,h5 { color: var(--uc2-blue); }
    /* navbar */
    .navbar         { background: var(--uc2-blue); }
    .navbar-brand,
    .navbar-nav .nav-link { color:#fff; }
    .navbar-nav .nav-link.active{ color: var(--uc2-green); }
    .navbar-nav .nav-link:hover{ color: var(--uc2-turquoise); }
    /* links in text */
    a{ color: var(--uc2-blue); }
    a:hover{ color: var(--uc2-turquoise); }
    footer{ background: var(--uc2-blue); color:#fff; }
    
    /* Custom styles for this page */
    .grid-container {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 1rem;
        margin: auto;
        padding: 0;
    }
    .grid1 {
        grid-area: 1 / 1 / 5 / 2;
        padding: 1rem;
    }
    .grid2, .grid3, .grid4, .grid5, .grid6 {
        padding: 1rem;
    }
    .Button {
        background-color: var(--uc2-blue);
        color: white;
        border: none;
        padding: 8px 16px;
        margin: 4px;
        border-radius: 4px;
        cursor: pointer;
    }
    .Button:hover {
        background-color: var(--uc2-turquoise);
    }
    .inputField {
        background-color: #fff;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    .inputFieldWide {
        width: 100%;
    }
    .form-select {
        width: 100%;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
        margin-top: 5px;
    }
    .slider {
        width: 100%;
    }
    .svg {
        width: 100%;
        height: auto;
    }
    @media (max-width: 768px) {
        .grid-container {
            grid-template-columns: 1fr;
        }
    }
  </style>
    <script> 
        var Frequenzen=[];
        var Messreihe=[]; 
        var MessreihenHerunterladen=[];
        var AngezeigteDatenpunkte=[];
        var fBegin=2820, fEnd=2920, fStep=2, N_freq=0; 
        var _fBegin=2820, _fEnd=2920, _fStep=2; 
        var YMax=0, YMin=0;      
        var _YMax=0, _YMin=36000;
        const fMin=2200, fMax=4400, stepMin=0.2, stepMax=5; 
        const IntMin=0, IntMax=36000, IntRangeMin=200;  
        const XPlotSize=1600, YPlotSize=800; 
        var AutoMessung=0;  
        const PlotViewBox="-200 -" + (YPlotSize+75) + " " + (XPlotSize+200+150) + " " + (YPlotSize+75+150);
        const CircSize="5";
        const MinSkaleneinteilungY=50;                  
        var XSkalierfaktor=1, XVerschiebung=0;
        var YSkalierfaktor=1, YVerschiebung=0;

        const ns="http://www.w3.org/2000/svg";
        var setAttrs=(e,a)=>Object.entries(a).forEach(([k,v])=>e.setAttribute(k,v));
        var scaleV=(x,a,b)=>a*x+b;    
        var ById=(ID)=>document.getElementById(ID); 
        function addValue(by,id){ById(id).value=parseFloat(by)+parseFloat(ById(id).value);unlockSendData()}
        function uncheck(id){ById(id).checked=false} 

    </script>
    
    <script> 
        async function MessungStarten(){ 
            ToggleStart(0);
            setLEDStatus('measuring', 'Messung l√§uft');
            enableADF();
            
            deleteScaleGroup("DataGroupID");    
            AngezeigteDatenpunkte=[];
            _YMax=0, _YMin=36000;
            prepareFreqs();             
            prepareXSkala(fBegin,fEnd);
            while(Frequenzen.length!=0){   
                var response=await freqMessung(Frequenzen.shift()); 
                Messreihe.push(response);  
                _YMin=Math.min(_YMin,response[1]-100);
                _YMax=Math.max(_YMax,response[1]+100);
                autoScale();
                drawCircle(response,+200,"black");  
            }
            addDataGroup(); 
            Messreihe=[];
            
            setLEDStatus('ready', 'Messungen abgeschlossen');
            
            if(AutoMessung){
                setTimeout(MessungStarten, 600);
            } else {
                ToggleStart(1);
                disableADF();
            }  
        }
        function autoScale(){
            if(ById("YMidAuto").checked){
                ymid=ById("YMid1");
                ymid.value=Math.floor((+_YMax+_YMin)/2);
                YMidContr(ymid);
            }
            if(ById("YRangeAuto").checked){   
                yrange=ById("YRange1");
                yrange.value=Math.abs(_YMax-_YMin);
                YRangeContr(yrange);
            }
            if(ById("YMidAuto").checked||ById("YRangeAuto").checked){adaptYScale();}
        }
        function MessreiheAnzeigen(id,row){
            for(let i=0;i < MessreihenHerunterladen[id].length;i++){
                drawCircle(MessreihenHerunterladen[id][i],+200,ById(row).lastChild.lastChild.value);  
            }
        }
        function randbedingungenUebernehmen(){ 
            ById("sendData").disabled=true;
            _fBegin=parseFloat(ById("f_begin").value);
            _fEnd=parseFloat(ById("f_end").value);
            _fStep=parseFloat(ById("f_step").value);
        }
        function unlockSendData(){
            [["f_begin",fMin,fMax-5],["f_end",5+parseFloat(ById("f_begin").value),fMax],["f_step",stepMin,stepMax]].forEach(element=>ById(element[0]).value=Math.min(element[2],Math.max(element[1],ById(element[0]).value)));
            ById("f_step").value=parseFloat(ById("f_step").value).toFixed(1);
            ById("sendData").disabled=false;
            updateParameterSummary();
        }
        
        // LED Status Functions
        function setLEDStatus(status, text) {
            const led = ById('statusLED');
            const statusText = ById('statusText');
            
            switch(status) {
                case 'ready':
                    led.style.backgroundColor = '#6c757d'; // Gray
                    break;
                case 'measuring':
                    led.style.backgroundColor = '#28a745'; // Green
                    led.style.animation = 'pulse 1s infinite';
                    break;
                case 'error':
                    led.style.backgroundColor = '#dc3545'; // Red
                    led.style.animation = 'none';
                    break;
                case 'laser_on':
                    led.style.backgroundColor = '#ffc107'; // Yellow
                    led.style.animation = 'none';
                    break;
                default:
                    led.style.backgroundColor = '#6c757d';
                    led.style.animation = 'none';
            }
            
            if (text) {
                statusText.textContent = text;
            }
        }
        
        // Add CSS animation for pulsing LED
        function addLEDAnimation() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulse {
                    0% { opacity: 1; }
                    50% { opacity: 0.5; }
                    100% { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // ADF Control Functions
        function enableADF() {
            // Send command to enable ADF4351
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/ADF_Enable", true);
            xhr.send();
        }
        
        function disableADF() {
            // Send command to disable ADF4351
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/ADF_Disable", true);
            xhr.send();
        }
        
        function updateParameterSummary() {
            const fBegin = parseFloat(ById("f_begin").value);
            const fEnd = parseFloat(ById("f_end").value);
            const fStep = parseFloat(ById("f_step").value);
            
            // Update frequency range
            ById("freqRange").textContent = `${fBegin} - ${fEnd} MHz`;
            
            // Update step size
            ById("stepSizeDisplay").textContent = `${fStep.toFixed(1)} MHz`;
            
            // Calculate data points
            const dataPoints = Math.floor((fEnd - fBegin) / fStep) + 1;
            ById("dataPointsCount").textContent = dataPoints;
            
            // Estimate scan time (assuming ~3 seconds per point)
            const estimatedSeconds = dataPoints * 3;
            const minutes = Math.floor(estimatedSeconds / 60);
            const seconds = estimatedSeconds % 60;
            ById("estimatedTime").textContent = `~${minutes}:${seconds.toString().padStart(2, '0')} min`;
        }
        function AutoToggle(){
            const Autobutton=ById("AutoMessung");
            const icon = Autobutton.querySelector('i');
            const span = Autobutton.querySelector('span');
            if (AutoMessung){ 
                icon.className = "bi bi-repeat";
                span.setAttribute('data-lang-key', 'single_measurement');
                span.textContent = "Einzelmessung";
                AutoMessung=0;
            } else { 
                icon.className = "bi bi-arrow-repeat";
                span.setAttribute('data-lang-key', 'continuous_measurement');
                span.textContent = "Dauermessung";
                AutoMessung=1;
            }
        }
        function fReset(){
            ById("f_begin").value=2820;
            ById("f_end").value=2920;
            ById("f_step").value=2;
            randbedingungenUebernehmen();
        }
        function LaserOn(){
            if(confirm("Laserdiode wirklich einschalten?")){
                var xhr=new XMLHttpRequest();
                xhr.open("POST","/Laser_An",true);
                xhr.send();
                let Laser=ById("Laser");
                Laser.innerHTML = '<i class="bi bi-lightbulb-fill"></i> Laserdiode ausschalten';
                Laser.className = "btn btn-danger btn-lg";
                Laser.removeEventListener("click", LaserOn);
                Laser.addEventListener("click", LaserOff);
                setLEDStatus('laser_on', 'Laser aktiv');
            }
        }
        function LaserOff(){
            var xhr=new XMLHttpRequest();
            xhr.open("POST","/Laser_Aus",true);
            xhr.send();
            let Laser=ById("Laser");
            Laser.innerHTML = '<i class="bi bi-lightbulb"></i> Laserdiode einschalten';
            Laser.className = "btn btn-warning btn-lg";
            Laser.removeEventListener("click", LaserOff);
            Laser.addEventListener("click", LaserOn);
            setLEDStatus('ready', 'Bereit');
        }
        function ToggleStart(OnOff){
            let StartButton=ById("StartStop");
            if(OnOff){
                StartButton.disabled=false;
                StartButton.innerHTML = '<i class="bi bi-play-fill"></i> <span data-lang-key="start_measurement">Messung starten</span>';
                StartButton.className = "btn btn-success btn-lg";
            } else {
                StartButton.disabled=true;
                StartButton.innerHTML = '<i class="bi bi-hourglass-split"></i> <span data-lang-key="measurement_running">Messung l√§uft</span>';
                StartButton.className = "btn btn-secondary btn-lg";
            }
        }
        function DownloadCSV(){
            var csv_data = [];
            var mostValues=0;
            if (MessreihenHerunterladen.length==0){
                alert("Es sind keine Messungen vorhanden,\n die heruntergeladen werden k√∂nnen.");
                return;
            }
            var csv_header=[];
            for (var i=0;i<MessreihenHerunterladen.length;i++){
                csv_header.push("Messreihe " + i + ";;");
            }
            csv_data.push(csv_header.join("; ;"));
            var csv_columnTitle=[];
            for (var i=0;i<MessreihenHerunterladen.length;i++){
                csv_columnTitle.push("Frequenz;Intensitaet;Magnetfeld");
            }
            csv_data.push(csv_columnTitle.join("; ;"));
            for (var i=0;i< MessreihenHerunterladen.length;i++){
                mostValues=Math.max(mostValues,MessreihenHerunterladen[i].length);
            }
            for (var i=0;i<mostValues;i++){
                var csv_row =[];
                for (var j=0; j < MessreihenHerunterladen.length;j++){
                    
                    var csv_tripel=[];
                    if (MessreihenHerunterladen[j].length<=i){
                        csv_row.push(" ; ; ")
                    }
                    else{
                        for (var k=0; k<3;k++){
                            csv_tripel.push(MessreihenHerunterladen[j][i][k]);
                        }
                        csv_row.push(csv_tripel.join(";"));
                    }
                }
                csv_data.push(csv_row.join("; ;"));
            }
            csv_data=csv_data.join("\n");
            CSVFile = new Blob([csv_data], { type: "text/csv" });
            var temp_link = document.createElement('a');
            temp_link.download = "Messungen.csv";
            var url = window.URL.createObjectURL(CSVFile);
            temp_link.href = url; 
            temp_link.style.display = "none";
            document.body.appendChild(temp_link);
            temp_link.click();
            document.body.removeChild(temp_link);
        }

    </script>
    <script>
        function prepareFreqs(){
            Frequenzen=[];                        
            fBegin=_fBegin;fEnd=_fEnd;fStep=_fStep; 
            for (let j=fBegin; j<=fEnd; j+=fStep ){ 
                Frequenzen.push(j);
            }
            N_freq=Frequenzen.length;         
            while (Messreihe.length>N_freq){       
                Messreihe.shift();              
            }
        }
        async function freqMessung(f){
            return new Promise(function(resolve){
                var xhr =new XMLHttpRequest();
                xhr.onreadystatechange=function() {if (this.readyState==4 && this.status ==200){resolve(this.responseText.split(" ").map(Number));}}
                xhr.open("GET", "/measure?frequenz=" + f, true);
                xhr.send();
            });
        }
        function getScalesteps(R){
            for(Step=1;R>Step;Step*=10){}                       
            if(R<Step/2){Step/=2;} 
            return(Step);
        }
        function prepareXSkala(_XMin,_XMax){
            deleteScaleGroup("XScaleGroupID");       
            XSkalierfaktor=XPlotSize/(_XMax-_XMin); 
            XVerschiebung=(0-_XMin)*XSkalierfaktor;   
            let XScaleSteps=getScalesteps((fEnd-fBegin)/12);
            for(let i=Math.ceil(fBegin/XScaleSteps)*XScaleSteps;i<=fEnd;i+=XScaleSteps){SkalaXStrich(i);}
        }
        
  
        
        function adaptYScale(){ 
            let YMinNew=+ById("YMid1").value-ById("YRange1").value/2;  
            let YMaxNew=+ById("YMid1").value+ById("YRange1").value/2; 
            let _YSkalierfaktor=YSkalierfaktor; YSkalierfaktor=YPlotSize/(YMinNew-YMaxNew); 
            let _YVerschiebung=YVerschiebung; YVerschiebung=(0-YMinNew)*YSkalierfaktor;
            deleteScaleGroup("YScaleGroupID");
            deleteScaleGroup("DataGroupID");
            let YScalesteps=getScalesteps((YMaxNew-YMinNew)/12);
            for (let i=Math.ceil(YMinNew/YScalesteps)*YScalesteps; i<YMaxNew; i=i+YScalesteps){
                SkalaYStrich(scaleV(i, _YSkalierfaktor, _YVerschiebung),scaleV(i, YSkalierfaktor, YVerschiebung),i);
            }
            for(let i=0; i<AngezeigteDatenpunkte.length;i++){
                let data=AngezeigteDatenpunkte.shift();
                drawCircle(data[0],data[1],data[2]);
            }

        }

    </script>   
    <script>
        function createTable(tableData) {
            var table=document.createElement('table');
            var tableBody=document.createElement('tbody');

            tableData.forEach(function(rowData) {
                var row=document.createElement('tr');
                rowData.forEach(function(cellData) {
                    var cell=document.createElement('td');
                    cell.appendChild(document.createTextNode(cellData));
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            })
            table.appendChild(tableBody);
            document.body.appendChild(table);
        }

        function SkalaXStrich(f){
            const XScaleGroup=ById("XScaleGroupID");
            var XLine=document.createElementNS(ns,"line");
            var xWert=scaleV(f,XSkalierfaktor,XVerschiebung); 
            setAttrs(XLine, { x1: xWert, x2:xWert, y1: "50", y2: "100", stroke: "#000000", "stroke-width": "3"});
            
            XScaleGroup.appendChild(XLine);
            var Beschriftung=document.createElementNS(ns,"text");
            setAttrs(Beschriftung, { x: xWert,  y: "125", style: "font:  30px Calibri ", "text-anchor": "middle", "alignment-baseline": "Central"});
            Beschriftung.textContent=f;
            XScaleGroup.appendChild(Beschriftung);
        }
        
        function SkalaYStrich(_scaleY,scaleY,Y){
            const YScaleGroup=ById("YScaleGroupID");
            var YLine=document.createElementNS(ns,"line");
            setAttrs(YLine, { x1: "-80", x2:"-50", y1: _scaleY, y2: _scaleY, stroke: "#000000", "stroke-width": "3"});
            YScaleGroup.appendChild(YLine);
            var Beschriftung=document.createElementNS(ns,"text");
            setAttrs(Beschriftung, { x:"-85", y: _scaleY, style: "font:  30px Calibri ", "text-anchor": "end", "alignment-baseline": "Central"});
            Beschriftung.textContent=Y;
            YScaleGroup.appendChild(Beschriftung);
            if(_scaleY!=scaleY){for(let i=0; i<3;i++){
                let _Elements=[YLine,YLine,Beschriftung], attributeNames=["y1","y2","y"];
                const animy=document.createElementNS(ns, "animate");
                setAttrs(animy, {attributeName: attributeNames[i], begin: "indefinite", dur: "0.1", to: scaleY, fill: "freeze"});
                _Elements[i].appendChild(animy);
                animy.beginElement();
            }}
        }

        function drawCircle(_Mess,yAnimStart,col) {
            let XY=[scaleV(_Mess[0],XSkalierfaktor,XVerschiebung),scaleV(_Mess[1], YSkalierfaktor, YVerschiebung)];
            AngezeigteDatenpunkte.push([_Mess,XY[1],col]);
            const DataGroup=ById("DataGroupID");
            var point =document.createElementNS(ns, "circle");
            setAttrs(point, {cx: scaleV(_Mess[0],XSkalierfaktor,XVerschiebung), cy: yAnimStart, r: CircSize, fill: col, stroke:"black", strokewidth:"2"});
            DataGroup.appendChild(point);
            point.addEventListener("mouseover",function(){showcoordinates(point,XY,_Mess);});
            point.addEventListener("mouseleave",function(){hidecoordinates(point,CircSize);});
            point.addEventListener("touchstart",function(){showcoordinates(point,XY,_Mess);});
            point.addEventListener("touchend",function(){hidecoordinates(point,CircSize);});
            const animY=document.createElementNS(ns, "animate");
            setAttrs(animY, {attributeName: "cy", begin: "indefinite", dur: "0.1", to: XY[1], fill: "freeze"});
            point.appendChild(animY);
            animY.beginElement();
        }

        function showcoordinates(point,XY,_Mess){
            let Coordinates=document.createElementNS(ns, "text");
            setAttrs(Coordinates, { id:"Coordinates", y: XY[1], style: "font: 30px Calibri", "text-anchor": "front", "alignment-baseline": "Hanging"});
            ById("DataGroupID").appendChild(Coordinates);
            let banner=document.createElementNS(ns, "rect");
            setAttrs(banner, {id:"cBanner", x:XY[0]+20, y:XY[1], width:"210", height:"120", fill:"#C4A770df", stroke:"#000", "stroke-width":"2",rx:"15"});
            if(XY[0]+30+240>=2150){setAttrs(banner, {x:XY[0]-230});}
            ById("DataGroupID").insertBefore(banner,Coordinates);
            let info=[];let infotext=["f = " + _Mess[0].toFixed(1) + " MHz","I = " + _Mess[1],"B = " + _Mess[2]]
            for(let i=0; i<3;i++){
                info[i]=document.createElementNS(ns, "tspan");
                setAttrs(info[i], {x: (XY[0]+30),dy:"35px"});
                if(XY[0]+30+240>=2150){setAttrs(info[i], {dx: "-250"});}
                info[i].textContent=infotext[i];
                Coordinates.appendChild(info[i]);
            }
            changeDatapointSize(point,10)
        }

        function hidecoordinates(point,r){
            ById("DataGroupID").removeChild(ById("cBanner"));
            ById("DataGroupID").removeChild(ById("Coordinates"));
            let Coordinates=document.createElementNS(ns, "text");
            changeDatapointSize(point,r)
        }

        function changeDatapointSize(point,r){
            let animR=document.createElementNS(ns, "animate");
            setAttrs(animR, {attributeName: "r", begin: "indefinite", dur: "0.1", to: r , fill: "freeze"});
            point.appendChild(animR);
            animR.beginElement();
        }

        function deleteScaleGroup(GroupID){
            let plot=ById("PlotSVGID");
            let ScaleGroup=ById(GroupID);
            plot.removeChild(ScaleGroup);
            ScaleGroup=document.createElementNS(ns, "g");
            ScaleGroup.setAttribute("id", GroupID);
            plot.appendChild(ScaleGroup);
        }
        

        function addDataGroup(){
            MessreihenHerunterladen.push(Messreihe);
            const Eingabefeld=ById("Messungen");
            let NR=MessreihenHerunterladen.length-1;
            var row=Eingabefeld.insertRow(NR);
            row.id='Messreihe'+String(NR);
            var _Cells=[];
            let b_av=0;
            for(let i=0; i<7;i++){
                _Cells[i]=row.insertCell(i);
            }
            for(let i=0; i<Messreihe.length;i++){b_av+=Messreihe[i][2];} b_av=Math.round(b_av/Messreihe.length);
            var inhalt=[MessreihenHerunterladen.length,fBegin,fEnd,fStep,b_av]
            var check=document.createElement('input');
            check.type='checkbox';
            check.class="TableCheckBox"
            _Cells[0].appendChild(check);
            for(let i=0; i<5;i++){
                _Cells[i+1].innerHTML=String(inhalt[i]);
            }
            var BTN1=document.createElement('button');
            BTN1.innerHTML='Messreihe L√∂schen';
            BTN1.type='button';
            _Cells[6].appendChild(BTN1);
            BTN1.addEventListener("click",()=>{row.remove();MessreihenHerunterladen.splice(NR, 1)});
            var BTN2=document.createElement('button');
            BTN2.innerHTML='Anzeigen';
            BTN2.type='button';
            _Cells[6].appendChild(BTN2);
            BTN2.addEventListener("click",()=>MessreiheAnzeigen(NR,row.id));
            var BTN3=document.createElement('input');
            BTN3.type='color';
            BTN3.value='#ff0000';
            _Cells[6].appendChild(BTN3);
        }
    </script>
</head>



<body>
  <!-- ‚ñë‚ñë Navbar ‚ñë‚ñë----------------------------------------------------------- -->
  <nav class="navbar navbar-expand-lg shadow-sm mb-4">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">NV-Experimente</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#nvNav" aria-controls="nvNav" aria-expanded="false">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="nvNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html" data-lang-key="nav_start">Start</a></li>
          <li class="nav-item"><a class="nav-link active" href="messung.html" data-lang-key="nav_measurement_device">Messung (on Device)</a></li>
          <li class="nav-item" id="webSerialNavItem"><a class="nav-link" href="messung_webserial.html" data-lang-key="nav_measurement_webserial">Messung (WebSerial)</a></li>
          <li class="nav-item"><a class="nav-link" href="justage.html" data-lang-key="nav_alignment">Justage</a></li>
          <li class="nav-item"><a class="nav-link" href="infos.html" data-lang-key="nav_info">Weitere Infos</a></li>
                  <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="langDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              üåê DE
            </a>
            <ul class="dropdown-menu" aria-labelledby="langDropdown">
              <li><a class="dropdown-item" href="#" onclick="setLanguage('de'); return false;">üá©üá™ Deutsch</a></li>
              <li><a class="dropdown-item" href="#" onclick="setLanguage('en'); return false;">üá∫üá∏ English</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ‚ñë‚ñë Main content ‚ñë‚ñë------------------------------------------------------ -->
  <div class="container-fluid">
    <h1 class="display-6 mb-4 text-center">Messung der Lichtintensit√§t in Abh√§ngigkeit von der Frequenz</h1>
    
    <main class="Block">
    <div class="grid-container">
        <div class="grid1" id="fullPlot">
            <svg xmlns="http://www.w3.org/2000/svg" style="border: 1px solid rgb(255, 255, 255);  background-color: #ffffff"  id="PlotSVGID" class="svg" >
                <line id="XAxisID" x1="-20" x2="1700" y1="50" y2="50" stroke="#000000" stroke-width="3"/>
                <line  x1="-50" x2="-30" y1="50" y2="50" stroke="#000000" stroke-width="3"  />
                <line  x1="-35" x2="-25" y1="65" y2="35" stroke="#000000" stroke-width="3"  />
                <line  x1="-25" x2="-15" y1="65" y2="35" stroke="#000000" stroke-width="3"  />
                <polyline points="1680,40 1700,50 1680,60" fill="none" stroke="black" stroke-width="3"/>
                <text  x="1690" y="90" text-anchor="middle" alignment-baseline="Central" style="font:  35px Calibri"><tspan alignment-baseline="Central" style="font: italic  35px Calibri">f</tspan><tspan alignment-baseline="Central" style="font:  35px Calibri">/MHz</tspan></text>
                
                <line id="YAxisID" x1="-50" x2="-50" y1="10" y2="-855" stroke="#000000" stroke-width="3"/>
                <line  x1="-50" x2="-50" y1="50" y2="20" stroke="#000000" stroke-width="3"  />
                <line  x1="-35" x2="-65" y1="5" y2="15" stroke="#000000" stroke-width="3"  />
                <line  x1="-35" x2="-65" y1="15" y2="25" stroke="#000000" stroke-width="3"  />
                <polyline points="-60,-835 -50,-855 -40,-835" fill="none" stroke="black" stroke-width="3"/>
                <text  x="-85" y="-845" text-anchor="middle" alignment-baseline="Central" style="font: italic 35px Calibri">I</text>
                
                <line  x1="-85" x2="-50" y1="85" y2="50" stroke="#000000" stroke-width="3" />
                <text  x="-85" y="100" text-anchor="end" alignment-baseline="Central" style="font:  30px Calibri ">0</text>
                <g id="DataGroupID"  />
                <g id="XScaleGroupID" />
                <g id="YScaleGroupID" />
                <script>
                    const plot=ById("PlotSVGID");
                    plot.setAttribute("viewBox", PlotViewBox);
                </script>
            </svg>
        </div>
        <div class="grid2">
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-warning btn-lg" id="Laser"
                      title="Schaltet die Laserdiode ein/aus f√ºr die Anregung der NV-Zentren" 
                      data-bs-toggle="tooltip">
                <i class="bi bi-lightbulb"></i> Laserdiode einschalten
              </button>
              <!-- LED Status Indicator -->
              <div class="d-flex align-items-center justify-content-center mt-2">
                <div id="statusLED" class="me-2" style="width: 12px; height: 12px; border-radius: 50%; background-color: #6c757d; border: 2px solid #dee2e6;"></div>
                <small id="statusText" class="text-muted">Bereit</small>
              </div>
            </div>
        </div>
        <div class="grid3">
            <div class="inputField inputFieldWide" id="Y-Controll" style="background-color: #fff;"> 
                    <label for="YMid1" >Y-Abschnitt: </label>
                    <input type="text"   id="YMid1" value=18000 onchange="YMidContr(this);adaptYScale();" />
                    <input type="range"  class="slider" id="YMid2" min="9000" max="27000" step="100" value=18000 oninput="YMidContr(this);adaptYScale();"/>
                    <input type="checkbox"  id="YMidAuto" checked=true onchange="autoScale()" style="display:block ">
            </div>
            <div class="inputField inputFieldWide" id="YR-Controll" style="background-color: #fff;">
                    <label for="YRange2">Y-Bereich: </label>
                    <input type="text"  id="YRange1" value="18000" onchange="YRangeContr(this);adaptYScale();"> 
                    <input type="range" class="slider" id="YRange2" min="0" max="8.5" step="0.1" value=7 oninput="YRangeContr2(this);adaptYScale();"/>
                    <input type="checkbox" id="YRangeAuto" checked=true onchange="autoScale()"style="display:flex">
            </div>
        </div>

        <div class="grid4">
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-success btn-lg" id="StartStop"
                      title="Startet die ODMR-Messung √ºber den gew√§hlten Frequenzbereich" 
                      data-bs-toggle="tooltip">
                <i class="bi bi-play-fill"></i> <span data-lang-key="start_measurement">Messung starten</span>
              </button>
              <button type="button" class="btn btn-outline-primary" id="AutoMessung"
                      title="Wechselt zwischen Einzel- und Dauermessung" 
                      data-bs-toggle="tooltip">
                <i class="bi bi-repeat"></i> <span data-lang-key="single_measurement">Einzelmessung</span>
              </button>
            </div>
        </div>

        <div class="grid5">
            <div class="card">
              <div class="card-header py-2">
                <h6 class="mb-0" data-lang-key="sensor_settings">Sensor-Einstellungen</h6>
              </div>
              <div class="card-body py-2">
                <div class="mb-2">
                  <label for="gainSelect" class="form-label small" data-lang-key="gain">Verst√§rkung (Gain):</label>
                  <select id="gainSelect" class="form-select form-select-sm"
                          title="Bestimmt die Verst√§rkung des TSL2591 Lichtsensors" 
                          data-bs-toggle="tooltip">
                    <option value="0x00">Low (1x)</option>
                    <option value="0x10">Medium (25x)</option>
                    <option value="0x20">High (428x)</option>
                    <option value="0x30" selected>Max (9876x)</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="integrationSelect" class="form-label small" data-lang-key="integration_time">Integrationszeit:</label>
                  <select id="integrationSelect" class="form-select form-select-sm"
                          title="Bestimmt die Belichtungszeit des Sensors" 
                          data-bs-toggle="tooltip">
                    <option value="0x00" selected>100 ms</option>
                    <option value="0x01">200 ms</option>
                    <option value="0x02">300 ms</option>
                    <option value="0x03">400 ms</option>
                    <option value="0x04">500 ms</option>
                    <option value="0x05">600 ms</option>
                  </select>
                </div>
                <div class="d-grid">
                  <button type="button" class="btn btn-primary btn-sm" id="applyTSLSettings"
                          title="Wendet die neuen Sensor-Einstellungen an" 
                          data-bs-toggle="tooltip">
                    <i class="bi bi-gear"></i> <span data-lang-key="apply_settings">Einstellungen anwenden</span>
                  </button>
                </div>
                <div id="tslSettingsStatus" class="small mt-2 text-center"></div>
              </div>
            </div>
        </div>

        <div class="gridb1"></div> 
        </div>    

        <!-- ‚ñë‚ñë Frequency Parameter Controls ‚ñë‚ñë---------------------------------- -->
        <div class="card mt-4">
          <div class="card-header">
            <h5 class="mb-0" data-lang-key="scan_params">Scan-Parameter</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <!-- Start Frequency -->
              <div class="col-lg-4">
                <label for="f_begin" class="form-label" data-lang-key="start_freq">Startfrequenz (MHz)</label>
                <div class="input-group">
                  <button class="btn btn-outline-secondary" type="button" 
                          onclick="addValue('-100', 'f_begin')" 
                          title="100 MHz subtrahieren" data-bs-toggle="tooltip">-100</button>
                  <button class="btn btn-outline-secondary" type="button" 
                          onclick="addValue('-10', 'f_begin')"
                          title="10 MHz subtrahieren" data-bs-toggle="tooltip">-10</button>
                  <input type="number" class="form-control text-center" id="f_begin" 
                         value="2820" min="2200" max="3600" step="0.1"
                         title="Startfrequenz f√ºr den Sweep" data-bs-toggle="tooltip">
                  <button class="btn btn-outline-secondary" type="button" 
                          onclick="addValue('10', 'f_begin')"
                          title="10 MHz addieren" data-bs-toggle="tooltip">+10</button>
                  <button class="btn btn-outline-secondary" type="button" 
                          onclick="addValue('100', 'f_begin')"
                          title="100 MHz addieren" data-bs-toggle="tooltip">+100</button>
                </div>
              </div>
              
              <!-- End Frequency -->
              <div class="col-lg-4">
                <label for="f_end" class="form-label" data-lang-key="end_freq">Endfrequenz (MHz)</label>
                <div class="input-group">
                  <button class="btn btn-outline-secondary" type="button" 
                          onclick="addValue('-100', 'f_end')"
                          title="100 MHz subtrahieren" data-bs-toggle="tooltip">-100</button>
                  <button class="btn btn-outline-secondary" type="button" 
                          onclick="addValue('-10', 'f_end')"
                          title="10 MHz subtrahieren" data-bs-toggle="tooltip">-10</button>
                  <input type="number" class="form-control text-center" id="f_end" 
                         value="2920" min="2200" max="3600" step="0.1"
                         title="Endfrequenz f√ºr den Sweep" data-bs-toggle="tooltip">
                  <button class="btn btn-outline-secondary" type="button" 
                          onclick="addValue('10', 'f_end')"
                          title="10 MHz addieren" data-bs-toggle="tooltip">+10</button>
                  <button class="btn btn-outline-secondary" type="button" 
                          onclick="addValue('100', 'f_end')"
                          title="100 MHz addieren" data-bs-toggle="tooltip">+100</button>
                </div>
              </div>
              
              <!-- Step Size -->
              <div class="col-lg-4">
                <label for="f_step" class="form-label" data-lang-key="step_size">Schrittweite (MHz)</label>
                <div class="input-group">
                  <button class="btn btn-outline-secondary" type="button" 
                          onclick="addValue('-1', 'f_step')"
                          title="1 MHz subtrahieren" data-bs-toggle="tooltip">-1</button>
                  <input type="number" class="form-control text-center" id="f_step" 
                         value="2.0" min="0.1" max="5" step="0.1"
                         title="Schrittweite zwischen Messpunkten" data-bs-toggle="tooltip">
                  <button class="btn btn-outline-secondary" type="button" 
                          onclick="addValue('1', 'f_step')"
                          title="1 MHz addieren" data-bs-toggle="tooltip">+1</button>
                </div>
              </div>
            </div>
            
            <div class="row mt-3">
              <div class="col-md-6">
                <button type="button" class="btn btn-primary me-2" id="sendData" disabled 
                        title="√úbernimmt die neuen Parameter" data-bs-toggle="tooltip" data-lang-key="apply_data">
                  <i class="bi bi-check2-circle"></i> Daten √ºbernehmen
                </button>
                <button type="button" class="btn btn-secondary" id="f_Reset"
                        title="Setzt alle Werte auf Standard zur√ºck" data-bs-toggle="tooltip" data-lang-key="reset">
                  <i class="bi bi-arrow-clockwise"></i> Zur√ºcksetzen
                </button>
              </div>
              <div class="col-md-6 text-end">
                <button type="button" class="btn btn-success me-2" id="MessreiheHerunterladen"
                        title="L√§dt alle Messungen als CSV-Datei herunter" data-bs-toggle="tooltip" data-lang-key="download_csv">
                  <i class="bi bi-download"></i> Download CSV
                </button>
                <button type="button" class="btn btn-warning" id="Clear"
                        title="L√∂scht alle Datenpunkte aus der Anzeige" data-bs-toggle="tooltip" data-lang-key="clear">
                  <i class="bi bi-eraser"></i> Leeren
                </button>
              </div>
            </div>
            
            <!-- Parameter Summary -->
            <div class="row mt-3">
              <div class="col-12">
                <div class="alert alert-info mb-0">
                  <div class="row text-center">
                    <div class="col-md-3">
                      <small class="text-muted d-block">Frequenzbereich</small>
                      <span id="freqRange">2820 - 2920 MHz</span>
                    </div>
                    <div class="col-md-3">
                      <small class="text-muted d-block">Schrittweite</small>
                      <span id="stepSizeDisplay">2.0 MHz</span>
                    </div>
                    <div class="col-md-3">
                      <small class="text-muted d-block">Datenpunkte</small>
                      <span id="dataPointsCount">51</span>
                    </div>
                    <div class="col-md-3">
                      <small class="text-muted d-block">Scan-Dauer</small>
                      <span id="estimatedTime">~2.5 min</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
            </div>


        </form>

        <form>
            <h2>Durchgef√ºhrte Messungen</h2>
            <div>
                <table>
                    <tr>
                        <th width=25> </th>
                        <th width=50>#</th>
                        <th width=100>f<sub>Begin</sub></th>
                        <th width=100>f<sub>End</sub></th>
                        <th width=100>&Delta;f</th>
                        <th width=100>B</th>
                        <th>Anzeigen</th> 
                    </tr>
                    <tbody id="Messungen">
                    </tbody>    
                </table>
            </div>
        </form>
        <script>
            // TSL2591 Settings Management
            function loadTSLSettings() {
                fetch('/tsl/settings')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            throw new Error('TSL settings endpoint not available');
                        }
                        return response.json();
                    })
                    .then(data => {
                        ById('gainSelect').value = '0x' + data.gain.toString(16).toUpperCase().padStart(2, '0');
                        ById('integrationSelect').value = '0x' + data.integration_time.toString(16).toUpperCase().padStart(2, '0');
                        ById('tslSettingsStatus').textContent = 'Einstellungen geladen';
                        ById('tslSettingsStatus').style.color = 'var(--uc2-green)';
                    })
                    .catch(error => {
                        console.error('Error loading TSL settings:', error);
                        ById('tslSettingsStatus').textContent = 'TSL Endpoint nicht verf√ºgbar';
                        ById('tslSettingsStatus').style.color = 'orange';
                    });
            }
            
            function applyTSLSettings() {
                const gain = parseInt(ById('gainSelect').value);
                const integrationTime = parseInt(ById('integrationSelect').value);
                
                ById('tslSettingsStatus').textContent = 'Wird angewendet...';
                ById('tslSettingsStatus').style.color = 'var(--uc2-turquoise)';
                
                // Set gain
                fetch('/tsl/gain?gain=' + gain, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        // Set integration time
                        return fetch('/tsl/integration_time?integration_time=' + integrationTime, { method: 'POST' });
                    })
                    .then(response => response.json())
                    .then(data => {
                        ById('tslSettingsStatus').textContent = 'Erfolgreich angewendet';
                        ById('tslSettingsStatus').style.color = 'var(--uc2-green)';
                    })
                    .catch(error => {
                        console.error('Error applying TSL settings:', error);
                        ById('tslSettingsStatus').textContent = 'Fehler beim Anwenden';
                        ById('tslSettingsStatus').style.color = 'red';
                    });
            }
            
            // Load TSL settings on page load
            document.addEventListener('DOMContentLoaded', function() {
                loadTSLSettings();
            });
            
            // Add event listener for apply button
            ById('applyTSLSettings').addEventListener('click', applyTSLSettings);
            
            function YMidContr(_this){ 
                if(isNaN(_this.value)){_this.value=_this.nextElementSibling.value;} 
                else if(_this.value<IntMin+ById("YRange1").value/2){_this.value=IntMin+ById("YRange1").value/2;}
                else if(_this.value>IntMax-ById("YRange1").value/2){_this.value=IntMax-ById("YRange1").value/2;} 
                if(_this.type=="text"){_this.nextElementSibling.value=_this.value;}
                else{_this.previousElementSibling.value=_this.value;}
                //autoScale();
            }
            
            function YRangeContr(_this){
                if(isNaN(_this.value)){_this.value=_this.nextElementSibling.value;}     
                else if((ById("YMid1").value-IntMin)*2<_this.value){ById("YMid1").value=IntMin+_this.value/2;ById("YMid2").value=IntMin+_this.value/2;}
                else if((IntMax-ById("YMid1").value)*2<_this.value){ById("YMid1").value=IntMax-_this.value/2;ById("YMid2").value=IntMax-_this.value/2;}
                if(_this.type=="text"){_this.nextElementSibling.value=_this.value;} 
                else{_this.previousElementSibling.value=_this.value;} 
                ById("YMid2").max=IntMax-_this.value/2; 
                ById("YMid2").min=IntMin+_this.value/2; 
            }
            function YRangeContr2(_this){
                let Intensit√§tswertLogarithmisch=Math.min(100*Math.floor(Math.pow(2, _this.value)),36000);
                if((ById("YMid1").value-IntMin)*2<Intensit√§tswertLogarithmisch){ById("YMid1").value=IntMin+Intensit√§tswertLogarithmisch/2;ById("YMid2").value=IntMin+Intensit√§tswertLogarithmisch/2;}
                else if((IntMax-ById("YMid1").value)*2<Intensit√§tswertLogarithmisch){ById("YMid1").value=IntMax-Intensit√§tswertLogarithmisch/2;ById("YMid2").value=IntMax-Intensit√§tswertLogarithmisch/2;}
                _this.previousElementSibling.value=Intensit√§tswertLogarithmisch; 
                ById("YMid2").max=IntMax-Intensit√§tswertLogarithmisch/2;     
                ById("YMid2").min=IntMin+Intensit√§tswertLogarithmisch/2;
            }            
            adaptYScale();
            
            // Initialize LED animation
            addLEDAnimation();
            
            // Initialize tooltips
            if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }

            // Hide WebSerial navigation item if on ESP32
            const isLocalDevice = window.location.hostname === '192.168.4.1' || 
                               window.location.hostname.includes('ODMR_') || 
                               window.location.protocol === 'file:';
            
            if (isLocalDevice) {
                const webSerialNavItem = document.getElementById('webSerialNavItem');
                if (webSerialNavItem) {
                    webSerialNavItem.style.display = 'none';
                }
            }
            
            // Initialize parameter summary
            updateParameterSummary();

            
            let ChangeListeners=[
                ["f_begin", unlockSendData ],
                ["f_end", unlockSendData ],
                ["f_step", unlockSendData ],
            ];
            let InputListeners=[
                ["YMid1", ()=>uncheck("YMidAuto")],
                ["YMid2", ()=>uncheck("YMidAuto")],
                ["YRange1", ()=>uncheck("YRangeAuto")],
                ["YRange2", ()=>uncheck("YRangeAuto")],
            ];
            let ClickListeners=[
                ["sendData", randbedingungenUebernehmen],
                ["f_Reset", fReset],
                ["StartStop", MessungStarten],
                ["AutoMessung", AutoToggle],
                ["fB-100",()=>addValue("-100","f_begin")],
                ["fB-10",()=>addValue("-10","f_begin")],
                ["fB10",()=>addValue("10","f_begin")],
                ["fB100",()=>addValue("100","f_begin")],
                ["fE-100",()=>addValue("-100","f_end")],
                ["fE-10",()=>addValue("-10","f_end")],
                ["fE10",()=>addValue("10","f_end")],
                ["fE100",()=>addValue("100","f_end")],
                ["fs-1",()=>addValue("-1","f_step")],
                ["fs1",()=>addValue("1","f_step")],
                ["Laser", LaserOn],
                ["Clear", ()=>{deleteScaleGroup("DataGroupID");AngezeigteDatenpunkte=[];_YMax=0, _YMin=36000;}],
                ["MessreiheHerunterladen",DownloadCSV],
            ];
            ChangeListeners.forEach(element => ById(element[0]).addEventListener("change", element[1]));
            InputListeners.forEach(element => ById(element[0]).addEventListener("input", element[1]));
            ClickListeners.forEach(element => ById(element[0]).addEventListener("click", element[1]));
        </script>

        </main>
  </div>

  <!-- ‚ñë‚ñë Footer ‚ñë‚ñë----------------------------------------------------------- -->
  <footer class="py-3 mt-auto">
    <div class="container text-center small">
      <div>Uni M√ºnster ¬∑ openUC2 GmbH ‚Äì <a class="text-white text-decoration-none" href="mailto:hello@openuc2.com">hello@openuc2.com</a></div>
      <div class="mt-1" id="versionInfo" style="opacity: 0.7; font-size: 0.85em;">Loading version...</div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script>
    // Automatic Bootstrap JS loading: Use CDN for development, local for ESP32
    (function() {
      const isLocalDevice = window.location.hostname === '192.168.4.1' || 
                           window.location.hostname.includes('ODMR_') || 
                           window.location.protocol === 'file:';
      
      if (isLocalDevice) {
        // Load from ESP32 local server
        document.write('<script src="/bootstrap.bundle.min.js"><\/script>');
      } else {
        // Load from CDN for development
        document.write('<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"><\/script>');
      }
    })();
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Fetch and display version information
      fetch('/version')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Version endpoint not available');
          }
          return response.json();
        })
        .then(data => {
          const versionInfo = document.getElementById('versionInfo');
          if (versionInfo) {
            versionInfo.textContent = `v${data.version} | Build: ${data.build_date} | ${data.git_hash}`;
          }
        })
        .catch(error => {
          console.error('Error fetching version:', error);
          const versionInfo = document.getElementById('versionInfo');
          if (versionInfo) {
            versionInfo.textContent = 'Version: ESP32 ODMR Server';
          }
        });
    });
  </script>

  <script>
    // Multi-language support
    const translations = {
      de: {
        "nav_start": "Start",
        "nav_measurement_device": "Messung (on Device)",
        "nav_measurement_webserial": "Messung (WebSerial)",
        "nav_alignment": "Justage",
        "nav_info": "Weitere Infos",
        "title": "NV Experimente - Messung durchf√ºhren",
        "page_title": "Messung der Lichtintensit√§t in Abh√§ngigkeit von der Frequenz",
        "scan_params": "Scan-Parameter",
        "start_freq": "Startfrequenz (MHz)",
        "end_freq": "Endfrequenz (MHz)",
        "step_size": "Schrittweite (MHz)",
        "apply_data": "Daten √ºbernehmen",
        "reset": "Zur√ºcksetzen",
        "download_csv": "Download CSV",
        "clear": "Leeren",
        "start_measurement": "Messung starten",
        "measurement_running": "Messung l√§uft",
        "single_measurement": "Einzelmessung",
        "continuous_measurement": "Dauermessung",
        "sensor_settings": "Sensor-Einstellungen",
        "gain": "Verst√§rkung (Gain)",
        "integration_time": "Integrationszeit",
        "apply_settings": "Einstellungen anwenden"
      },
      en: {
        "nav_start": "Start",
        "nav_measurement_device": "Measurement (on Device)",
        "nav_measurement_webserial": "Measurement (WebSerial)",
        "nav_alignment": "Alignment",
        "nav_info": "More Info",
        "title": "NV Experiments - Perform Measurement",
        "page_title": "Measurement of Light Intensity as a Function of Frequency",
        "scan_params": "Scan Parameters",
        "start_freq": "Start Frequency (MHz)",
        "end_freq": "End Frequency (MHz)",
        "step_size": "Step Size (MHz)",
        "apply_data": "Apply Data",
        "reset": "Reset",
        "download_csv": "Download CSV",
        "clear": "Clear",
        "start_measurement": "Start Measurement",
        "measurement_running": "Measurement Running",
        "single_measurement": "Single Measurement",
        "continuous_measurement": "Continuous Measurement",
        "sensor_settings": "Sensor Settings",
        "gain": "Gain",
        "integration_time": "Integration Time",
        "apply_settings": "Apply Settings"
      }
    };
    
    function setLanguage(lang) {
      localStorage.setItem('language', lang);
      updateLanguage(lang);
      
      // Update dropdown display
      const langDropdown = document.getElementById('langDropdown');
      if (langDropdown) {
        langDropdown.innerHTML = `üåê ${lang.toUpperCase()}`;
      }
    }
    
    function updateLanguage(lang) {
      const elements = document.querySelectorAll('[data-lang-key]');
      elements.forEach(element => {
        const key = element.getAttribute('data-lang-key');
        if (translations[lang] && translations[lang][key]) {
          element.textContent = translations[lang][key];
        }
      });
      
      // Update title
      if (translations[lang] && translations[lang].title) {
        document.title = translations[lang].title;
      }
    }
    
    // Initialize language on page load
    document.addEventListener('DOMContentLoaded', function() {
      const savedLang = localStorage.getItem('language') || 'de';
      setLanguage(savedLang);
    });
  </script>
</body>
</html>


